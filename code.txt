com/missav/bot/bot/MissavBot.java
package com.missav.bot.bot;

import com.missav.bot.crawler.CrawlResult;
import com.missav.bot.push.service.IPushService;
import com.missav.bot.subscription.entity.Subscription;
import com.missav.bot.subscription.entity.Subscription.SubscriptionType;
import com.missav.bot.telegram.TelegramMessageService;
import com.missav.bot.video.entity.Video;
import com.missav.bot.video.mapper.VideoMapper;
import com.missav.bot.subscription.service.ISubscriptionService;
import com.missav.bot.crawler.service.ICrawlerService;
import jakarta.annotation.PostConstruct;
import lombok.extern.slf4j.Slf4j;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.telegram.telegrambots.bots.DefaultBotOptions;
import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.commands.SetMyCommands;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.methods.send.SendPhoto;
import org.telegram.telegrambots.meta.api.methods.send.SendVideo;
import org.telegram.telegrambots.meta.api.objects.InputFile;
import org.telegram.telegrambots.meta.api.objects.Message;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.api.objects.commands.BotCommand;
import org.telegram.telegrambots.meta.api.objects.commands.scope.BotCommandScopeDefault;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

import java.util.*;


@Slf4j
@Component
public class MissavBot extends TelegramLongPollingBot {
    super(getProxyOptions(), botToken);
    private final ISubscriptionService subscriptionService;
    private final VideoMapper videoMapper;
    private final ICrawlerService crawlerService;
    private final IPushService pushService;
    private final TelegramMessageService telegramMessageService;

    @Value("${telegram.bot.token}")
    private String botToken;

    @Value("${telegram.bot.username:MissavBot}")
    private String botUsername;

    public MissavBot(ISubscriptionService subscriptionService, VideoMapper videoMapper,
                     ICrawlerService crawlerService, IPushService pushService,
                     TelegramMessageService telegramMessageService) {
        super(createBotOptions());
        this.subscriptionService = subscriptionService;
        this.videoMapper = videoMapper;
        this.crawlerService = crawlerService;
        this.pushService = pushService;
        this.telegramMessageService = telegramMessageService;

        // è®¾ç½® TelegramMessageService çš„ bot å®ä¾‹
        this.telegramMessageService.setBot(this);
    }

    private static DefaultBotOptions createBotOptions() {
        DefaultBotOptions options = new DefaultBotOptions();
        options.setProxyHost("127.0.0.1");
        options.setProxyPort(7890);
        options.setProxyType(DefaultBotOptions.ProxyType.HTTP);
        options.setGetUpdatesTimeout(75);  // å¢åŠ è½®è¯¢è¶…æ—¶åˆ° 75 ç§’
        options.setMaxThreads(1);  // å‡å°‘çº¿ç¨‹æ•°
        return options;
    }

    @PostConstruct
    public void setupCommands() {
        try {
            List<BotCommand> commands = new ArrayList<>();
            commands.add(new BotCommand("start", "å¼€å§‹ä½¿ç”¨"));
            commands.add(new BotCommand("help", "æŸ¥çœ‹å¸®åŠ©"));
            commands.add(new BotCommand("subscribe", "è®¢é˜…æ–°ç‰‡"));
            commands.add(new BotCommand("unsubscribe", "å–æ¶ˆè®¢é˜…"));
            commands.add(new BotCommand("list", "æˆ‘çš„è®¢é˜…"));
            commands.add(new BotCommand("latest", "æœ€æ–°è§†é¢‘"));
            commands.add(new BotCommand("search", "æœç´¢è§†é¢‘"));
            commands.add(new BotCommand("status", "æœºå™¨äººçŠ¶æ€"));

            execute(new SetMyCommands(commands, new BotCommandScopeDefault(), null));
            log.info("Bot å‘½ä»¤èœå•è®¾ç½®æˆåŠŸ");
        } catch (TelegramApiException e) {
            log.error("è®¾ç½® Bot å‘½ä»¤èœå•å¤±è´¥", e);
        }
    }

    @Override
    public String getBotToken() {
        return botToken;
    }

    @Override
    public String getBotUsername() {
        return botUsername;
    }

    @Override
    public void onUpdateReceived(Update update) {
        if (!update.hasMessage() || !update.getMessage().hasText()) {
            return;
        }

        Message message = update.getMessage();
        String text = message.getText().trim();
        Long chatId = message.getChatId();
        String chatType = message.getChat().getType();

        log.info("æ”¶åˆ°æ¶ˆæ¯: chatId={}, type={}, text={}", chatId, chatType, text);

        // è‡ªåŠ¨ä¸ºæ–°ç¾¤ç»„åˆ›å»ºè®¢é˜…ï¼ˆä»…ç¾¤ç»„/è¶…çº§ç¾¤ç»„ï¼Œä¸åŒ…æ‹¬ç§èŠï¼‰
        // è·³è¿‡ /subscribe å‘½ä»¤ï¼Œé¿å…ä¸æ‰‹åŠ¨è®¢é˜…å†²çª
        if (("group".equals(chatType) || "supergroup".equals(chatType)) &&
            text.startsWith("/") && !text.toLowerCase().startsWith("/subscribe")) {
            try {
                List<Subscription> existingSubs = subscriptionService.getSubscriptions(chatId);
                if (existingSubs.isEmpty()) {
                    subscriptionService.subscribe(chatId, chatType, SubscriptionType.ALL, null);
                    log.info("è‡ªåŠ¨è®¢é˜…æ–°ç¾¤ç»„: chatId={}, type={}, title={}",
                        chatId, chatType, message.getChat().getTitle());
                }
            } catch (Exception e) {
                log.debug("è‡ªåŠ¨è®¢é˜…ç¾¤ç»„å¤±è´¥: chatId={}, error={}", chatId, e.getMessage());
            }
        }

        try {
            if (text.startsWith("/")) {
                handleCommand(chatId, chatType, text);
            }
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥", e);
            sendText(chatId, "âŒ å¤„ç†å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * å¤„ç†å‘½ä»¤
     */
    private void handleCommand(Long chatId, String chatType, String text) {
        String[] parts = text.split("\\s+", 2);
        String command = parts[0].toLowerCase().replace("@" + botUsername.toLowerCase(), "");
        String args = parts.length > 1 ? parts[1].trim() : "";

        switch (command) {
            case "/start", "/help" -> sendHelp(chatId);
            case "/subscribe" -> handleSubscribe(chatId, chatType, args);
            case "/unsubscribe" -> handleUnsubscribe(chatId, args);
            case "/list" -> handleList(chatId);
            case "/search" -> handleSearch(chatId, args);
            case "/latest" -> handleLatest(chatId, args);
            case "/crawl" -> handleCrawl(chatId, chatType, args);
            case "/status" -> handleStatus(chatId);
            default -> sendText(chatId, "â“ æœªçŸ¥å‘½ä»¤ï¼Œè¾“å…¥ /help æŸ¥çœ‹å¸®åŠ©");
        }
    }

    /**
     * å‘é€å¸®åŠ©ä¿¡æ¯
     */
    private void sendHelp(Long chatId) {
        String help = """
            ğŸ¬ *MissAV æœºå™¨äºº*

            ğŸ“Œ *è®¢é˜…å‘½ä»¤*
            /subscribe - è®¢é˜…å…¨éƒ¨æ–°ç‰‡
            /subscribe æ¼”å‘˜å - è®¢é˜…æŒ‡å®šæ¼”å‘˜
            /subscribe #æ ‡ç­¾ - è®¢é˜…æŒ‡å®šæ ‡ç­¾

            ğŸ“Œ *ç®¡ç†å‘½ä»¤*
            /unsubscribe - å–æ¶ˆå…¨éƒ¨è®¢é˜…
            /unsubscribe æ¼”å‘˜å - å–æ¶ˆæ¼”å‘˜è®¢é˜…
            /list - æŸ¥çœ‹æˆ‘çš„è®¢é˜…

            ğŸ“Œ *æŸ¥è¯¢å‘½ä»¤*
            /search å…³é”®è¯ - æœç´¢è§†é¢‘
            /latest - æŸ¥çœ‹æœ€æ–°è§†é¢‘
            /status - æŸ¥çœ‹æœºå™¨äººçŠ¶æ€

            ğŸ“Œ *æ‰‹åŠ¨çˆ¬å–å‘½ä»¤*
            /crawl actor æ¼”å‘˜å [æ•°é‡]
              ç¤ºä¾‹: /crawl actor ä¸‰ä¸Šæ‚ äºš 10
            /crawl code ç•ªå·
              ç¤ºä¾‹: /crawl code SSIS-001
            /crawl search å…³é”®è¯ [æ•°é‡]
              ç¤ºä¾‹: /crawl search SSIS 20

            ğŸ’¡ æœ‰æ–°è§†é¢‘æ—¶ä¼šè‡ªåŠ¨æ¨é€åˆ°æœ¬ç¾¤
            """;
        telegramMessageService.sendMarkdown(chatId, help);
    }

    /**
     * å¤„ç†è®¢é˜…
     */
    private void handleSubscribe(Long chatId, String chatType, String args) {
        if (args.isEmpty()) {
            // è®¢é˜…å…¨éƒ¨
            subscriptionService.subscribe(chatId, chatType, SubscriptionType.ALL, null);
            sendText(chatId, "âœ… å·²è®¢é˜…å…¨éƒ¨æ–°ç‰‡ï¼Œæœ‰æ–°è§†é¢‘ä¼šè‡ªåŠ¨æ¨é€");
        } else if (args.startsWith("#")) {
            // è®¢é˜…æ ‡ç­¾
            String tag = args.substring(1).trim();
            subscriptionService.subscribe(chatId, chatType, SubscriptionType.TAG, tag);
            sendText(chatId, "âœ… å·²è®¢é˜…æ ‡ç­¾: #" + tag);
        } else {
            // è®¢é˜…æ¼”å‘˜
            subscriptionService.subscribe(chatId, chatType, SubscriptionType.ACTRESS, args);
            sendText(chatId, "âœ… å·²è®¢é˜…æ¼”å‘˜: " + args);
        }
    }

    /**
     * å¤„ç†å–æ¶ˆè®¢é˜…
     */
    private void handleUnsubscribe(Long chatId, String args) {
        if (args.isEmpty()) {
            subscriptionService.unsubscribeAll(chatId);
            sendText(chatId, "âœ… å·²å–æ¶ˆå…¨éƒ¨è®¢é˜…");
        } else if (args.startsWith("#")) {
            String tag = args.substring(1).trim();
            subscriptionService.unsubscribe(chatId, SubscriptionType.TAG, tag);
            sendText(chatId, "âœ… å·²å–æ¶ˆæ ‡ç­¾è®¢é˜…: #" + tag);
        } else {
            subscriptionService.unsubscribe(chatId, SubscriptionType.ACTRESS, args);
            sendText(chatId, "âœ… å·²å–æ¶ˆæ¼”å‘˜è®¢é˜…: " + args);
        }
    }

    /**
     * æŸ¥çœ‹è®¢é˜…åˆ—è¡¨
     */
    private void handleList(Long chatId) {
        List<Subscription> subscriptions = subscriptionService.getSubscriptions(chatId);
        if (subscriptions.isEmpty()) {
            sendText(chatId, "ğŸ“­ æš‚æ— è®¢é˜…ï¼Œä½¿ç”¨ /subscribe æ·»åŠ è®¢é˜…");
            return;
        }

        StringBuilder sb = new StringBuilder("ğŸ“‹ *å½“å‰è®¢é˜…åˆ—è¡¨* (å…± " + subscriptions.size() + " ä¸ª)\n\n");
        for (Subscription sub : subscriptions) {
            switch (sub.getType()) {
                case ALL -> sb.append("â€¢ å…¨éƒ¨æ–°ç‰‡ (æ‰€æœ‰è§†é¢‘éƒ½ä¼šæ¨é€)\n");
                case ACTRESS -> sb.append("â€¢ æ¼”å‘˜: ").append(sub.getKeyword()).append("\n");
                case TAG -> sb.append("â€¢ æ ‡ç­¾: #").append(sub.getKeyword()).append("\n");
            }
        }
        sb.append("\nğŸ’¡ ä½¿ç”¨ /unsubscribe å–æ¶ˆè®¢é˜…");
        telegramMessageService.sendMarkdown(chatId, sb.toString());
    }

    /**
     * æœç´¢è§†é¢‘
     */
    private void handleSearch(Long chatId, String keyword) {
        if (keyword.isEmpty()) {
            sendText(chatId, "è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼Œä¾‹å¦‚: /search SSIS");
            return;
        }

        List<Video> videos = videoMapper.selectByActress(keyword);
        if (videos.isEmpty()) {
            videos = videoMapper.selectByTag(keyword);
        }

        if (videos.isEmpty()) {
            sendText(chatId, "ğŸ” æœªæ‰¾åˆ°ç›¸å…³è§†é¢‘");
            return;
        }

        StringBuilder sb = new StringBuilder("ğŸ” *æœç´¢ç»“æœ*\n\n");
        int count = 0;
        for (Video video : videos) {
            if (count >= 10) break;
            sb.append("â€¢ ").append(video.getCode())
              .append(" - ").append(truncate(video.getTitle(), 30))
              .append("\n");
            count++;
        }
        if (videos.size() > 10) {
            sb.append("\n...å…± ").append(videos.size()).append(" ä¸ªç»“æœ");
        }
        telegramMessageService.sendMarkdown(chatId, sb.toString());
    }

    /**
     * æŸ¥çœ‹æœ€æ–°è§†é¢‘
     */
    private void handleLatest(Long chatId, String args) {
        int page = 1;
        if (!args.isEmpty()) {
            try {
                page = Integer.parseInt(args);
                if (page < 1) page = 1;
            } catch (NumberFormatException e) {
                page = 1;
            }
        }

        List<Video> videos = videoMapper.selectTop50ByCreatedTimeDesc();
        if (videos.isEmpty()) {
            sendText(chatId, "æš‚æ— è§†é¢‘");
            return;
        }

        int pageSize = 5;
        int totalPages = (int) Math.ceil(videos.size() / (double) pageSize);
        int startIndex = (page - 1) * pageSize;
        int endIndex = Math.min(startIndex + pageSize, videos.size());

        if (startIndex >= videos.size()) {
            sendText(chatId, "âŒ é¡µç è¶…å‡ºèŒƒå›´,å…± " + totalPages + " é¡µ");
            return;
        }

        sendText(chatId, String.format("ğŸ“º æœ€æ–°è§†é¢‘ (ç¬¬ %d/%d é¡µ):", page, totalPages));

        for (int i = startIndex; i < endIndex; i++) {
            Video video = videos.get(i);

            // ä¸ºæ¯ä¸ªè§†é¢‘å‘é€å¸¦å°é¢çš„æ¶ˆæ¯
            String caption = telegramMessageService.formatVideoMessage(video);

            if (video.getCoverUrl() != null && !video.getCoverUrl().isEmpty()) {
                telegramMessageService.sendPhotoWithCaption(chatId, video.getCoverUrl(), caption);
            } else {
                telegramMessageService.sendMarkdown(chatId, caption);
            }

            // é¿å…å‘é€è¿‡å¿«
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }

        // æç¤ºç¿»é¡µ
        if (page < totalPages) {
            sendText(chatId, "ğŸ’¡ æŸ¥çœ‹ä¸‹ä¸€é¡µ: /latest " + (page + 1));
        }
    }

    /**
     * æŸ¥çœ‹çŠ¶æ€
     */
    private void handleStatus(Long chatId) {
        long videoCount = videoMapper.selectCount(null);
        String status = String.format("""
            ğŸ¤– *æœºå™¨äººçŠ¶æ€*

            ğŸ“Š è§†é¢‘åº“: %d ä¸ª
            â° æ£€æŸ¥é—´éš”: 15 åˆ†é’Ÿ
            âœ… è¿è¡Œæ­£å¸¸
            """, videoCount);
        telegramMessageService.sendMarkdown(chatId, status);
    }

    /**
     * å¤„ç†æ‰‹åŠ¨çˆ¬å–å‘½ä»¤
     */
    private void handleCrawl(Long chatId, String chatType, String args) {
        if (args.isEmpty()) {
            sendText(chatId, """
                â“ è¯·æŒ‡å®šçˆ¬å–æ–¹å¼:

                /crawl actor æ¼”å‘˜å [æ•°é‡]
                /crawl code ç•ªå·
                /crawl search å…³é”®è¯ [æ•°é‡]

                ç¤ºä¾‹:
                /crawl actor ä¸‰ä¸Šæ‚ äºš 10
                /crawl code SSIS-001
                /crawl search SSIS 20
                """);
            return;
        }

        String[] parts = args.split("\\s+", 3);
        String crawlType = parts[0].toLowerCase();

        try {
            switch (crawlType) {
                case "actor", "actress" -> handleCrawlByActor(chatId, chatType, parts);
                case "code" -> handleCrawlByCode(chatId, parts);
                case "search", "keyword" -> handleCrawlBySearch(chatId, chatType, parts);
                default -> sendText(chatId, "âŒ æœªçŸ¥çš„çˆ¬å–ç±»å‹ï¼Œè¯·ä½¿ç”¨: actorã€code æˆ– search");
            }
        } catch (Exception e) {
            log.error("çˆ¬å–å¤±è´¥", e);
            sendText(chatId, "âŒ çˆ¬å–å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * æŒ‰æ¼”å‘˜çˆ¬å–
     */
    private void handleCrawlByActor(Long chatId, String chatType, String[] parts) {
        // å®‰å…¨æ£€æŸ¥ï¼šä»…å…è®¸ç§èŠä½¿ç”¨
        if (!"private".equals(chatType)) {
            sendText(chatId, "âš ï¸ ä¸ºä¿æŠ¤éšç§å®‰å…¨ï¼Œæ¼”å‘˜çˆ¬å–åŠŸèƒ½ä»…æ”¯æŒç§èŠä½¿ç”¨");
            return;
        }

        if (parts.length < 2) {
            sendText(chatId, "âŒ è¯·æŒ‡å®šæ¼”å‘˜åï¼Œä¾‹å¦‚: /crawl actor ä¸‰ä¸Šæ‚ äºš 10");
            return;
        }

        String actorName = parts[1];
        Integer limit = null;

        if (parts.length >= 3) {
            try {
                limit = Integer.parseInt(parts[2]);
            } catch (NumberFormatException e) {
                sendText(chatId, "âŒ æ•°é‡å¿…é¡»æ˜¯æ•°å­—");
                return;
            }
        }

        sendText(chatId, String.format("â³ æ­£åœ¨çˆ¬å–æ¼”å‘˜ã€Œ%sã€çš„ä½œå“...", actorName));

        // åˆ›å»º final å˜é‡ä¾› lambda ä½¿ç”¨
        final Integer finalLimit = limit;
        final ICrawlerService service = this.crawlerService;

        // å¼‚æ­¥æ‰§è¡Œçˆ¬å–ï¼Œé¿å…é˜»å¡
        new Thread(() -> {
            try {
                CrawlResult result = service.crawlByActor(actorName, finalLimit);

                if (result.getNewVideos().isEmpty()) {
                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    if (result.getTotalCrawled() == 0) {
                        sendText(chatId, String.format("ğŸ” æœªæ‰¾åˆ°æ¼”å‘˜ã€Œ%sã€çš„ä½œå“", actorName));
                    } else {
                        sendText(chatId, String.format("ğŸ“Š çˆ¬å–å®Œæˆï¼Œä½†å…¨éƒ¨ä¸ºé‡å¤è§†é¢‘\n" +
                            "æ€»è®¡: %d | æ–°å¢: 0 | é‡å¤: %d",
                            result.getTotalCrawled(), result.getDuplicateCount()));
                    }
                    return;
                }

                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                sendText(chatId, String.format("âœ… çˆ¬å–å®Œæˆ\n" +
                    "ğŸ“Š æ€»è®¡: %d | ğŸ†• æ–°å¢: %d | ğŸ”„ é‡å¤: %d",
                    result.getTotalCrawled(), result.getNewCount(), result.getDuplicateCount()));

                // æ¨é€æ¯ä¸ªæ–°è§†é¢‘ç»™è§¦å‘è€…
                for (Video video : result.getNewVideos()) {
                    pushService.pushVideoToChat(video, chatId);
                    Thread.sleep(1000);
                }
            } catch (Exception e) {
                log.error("çˆ¬å–æ¼”å‘˜ä½œå“å¤±è´¥", e);
                sendText(chatId, "âŒ çˆ¬å–å¤±è´¥ï¼š" + e.getMessage());
            }
        }).start();
    }

    /**
     * æŒ‰ç•ªå·çˆ¬å–
     */
    private void handleCrawlByCode(Long chatId, String[] parts) {
        if (parts.length < 2) {
            sendText(chatId, "âŒ è¯·æŒ‡å®šç•ªå·ï¼Œä¾‹å¦‚: /crawl code SSIS-001");
            return;
        }

        String code = parts[1].toUpperCase();
        sendText(chatId, String.format("â³ æ­£åœ¨çˆ¬å–ç•ªå·ã€Œ%sã€...", code));

        // åˆ›å»º final å˜é‡ä¾› lambda ä½¿ç”¨
        final ICrawlerService service = this.crawlerService;

        // å¼‚æ­¥æ‰§è¡Œçˆ¬å–
        new Thread(() -> {
            try {
                Video video = service.crawlByCode(code);

                if (video == null) {
                    sendText(chatId, String.format("ğŸ” æœªæ‰¾åˆ°ç•ªå·ã€Œ%sã€", code));
                    return;
                }

                sendText(chatId, "âœ… çˆ¬å–æˆåŠŸ");
                pushService.pushVideoToChat(video, chatId);
            } catch (Exception e) {
                log.error("çˆ¬å–ç•ªå·å¤±è´¥", e);
                sendText(chatId, "âŒ çˆ¬å–å¤±è´¥ï¼š" + e.getMessage());
            }
        }).start();
    }

    /**
     * æŒ‰å…³é”®è¯æœç´¢çˆ¬å–
     */
    private void handleCrawlBySearch(Long chatId, String chatType, String[] parts) {
        // å®‰å…¨æ£€æŸ¥ï¼šä»…å…è®¸ç§èŠä½¿ç”¨
        if (!"private".equals(chatType)) {
            sendText(chatId, "âš ï¸ ä¸ºä¿æŠ¤éšç§å®‰å…¨ï¼Œå…³é”®è¯æœç´¢åŠŸèƒ½ä»…æ”¯æŒç§èŠä½¿ç”¨");
            return;
        }

        if (parts.length < 2) {
            sendText(chatId, "âŒ è¯·æŒ‡å®šå…³é”®è¯ï¼Œä¾‹å¦‚: /crawl search SSIS 20");
            return;
        }

        String keyword = parts[1];
        Integer limit = null;

        if (parts.length >= 3) {
            try {
                limit = Integer.parseInt(parts[2]);
            } catch (NumberFormatException e) {
                sendText(chatId, "âŒ æ•°é‡å¿…é¡»æ˜¯æ•°å­—");
                return;
            }
        }

        sendText(chatId, String.format("â³ æ­£åœ¨æœç´¢ã€Œ%sã€...", keyword));

        // åˆ›å»º final å˜é‡ä¾› lambda ä½¿ç”¨
        final Integer finalLimit = limit;
        final ICrawlerService service = this.crawlerService;

        // å¼‚æ­¥æ‰§è¡Œçˆ¬å–
        new Thread(() -> {
            try {
                CrawlResult result = service.crawlByKeyword(keyword, finalLimit);

                if (result.getNewVideos().isEmpty()) {
                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    if (result.getTotalCrawled() == 0) {
                        sendText(chatId, String.format("ğŸ” æœªæ‰¾åˆ°å…³é”®è¯ã€Œ%sã€ç›¸å…³çš„ä½œå“", keyword));
                    } else {
                        sendText(chatId, String.format("ğŸ“Š æœç´¢å®Œæˆï¼Œä½†å…¨éƒ¨ä¸ºé‡å¤è§†é¢‘\n" +
                            "æ€»è®¡: %d | æ–°å¢: 0 | é‡å¤: %d",
                            result.getTotalCrawled(), result.getDuplicateCount()));
                    }
                    return;
                }

                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                sendText(chatId, String.format("âœ… æœç´¢å®Œæˆ\n" +
                    "ğŸ“Š æ€»è®¡: %d | ğŸ†• æ–°å¢: %d | ğŸ”„ é‡å¤: %d",
                    result.getTotalCrawled(), result.getNewCount(), result.getDuplicateCount()));

                // æ¨é€æ¯ä¸ªæ–°è§†é¢‘ç»™è§¦å‘è€…
                for (Video video : result.getNewVideos()) {
                    pushService.pushVideoToChat(video, chatId);
                    Thread.sleep(1000);
                }
            } catch (Exception e) {
                log.error("æœç´¢çˆ¬å–å¤±è´¥", e);
                sendText(chatId, "âŒ çˆ¬å–å¤±è´¥ï¼š" + e.getMessage());
            }
        }).start();
    }

    /**
     * æ¨é€è§†é¢‘åˆ°èŠå¤©
     */
    public boolean pushVideo(Long chatId, Video video) {
        try {
            String caption = telegramMessageService.formatVideoMessage(video);

            // ä¼˜å…ˆå‘é€é¢„è§ˆè§†é¢‘
            if (video.getPreviewUrl() != null && !video.getPreviewUrl().isEmpty()) {
                return telegramMessageService.sendVideoWithCaption(chatId, video.getPreviewUrl(), video.getCoverUrl(), caption);
            }

            // å…¶æ¬¡å‘é€å°é¢å›¾
            if (video.getCoverUrl() != null && !video.getCoverUrl().isEmpty()) {
                return telegramMessageService.sendPhotoWithCaption(chatId, video.getCoverUrl(), caption);
            }

            // æœ€åå‘é€çº¯æ–‡æœ¬
            telegramMessageService.sendMarkdown(chatId, caption);
            return true;
        } catch (Exception e) {
            log.error("æ¨é€è§†é¢‘å¤±è´¥: chatId={}, code={}", chatId, video.getCode(), e);
            return false;
        }
    }


    private void sendText(Long chatId, String text) {
        try {
            SendMessage message = new SendMessage();
            message.setChatId(chatId.toString());
            message.setText(text);
            execute(message);
        } catch (TelegramApiException e) {
            log.error("å‘é€æ¶ˆæ¯å¤±è´¥", e);
        }
    }

    private String truncate(String text, int maxLength) {
        if (text == null) return "";
        return text.length() <= maxLength ? text : text.substring(0, maxLength) + "...";
    }
}


com/missav/bot/common/config/BotConfig.java
package com.missav.bot.common.config;

import com.missav.bot.bot.MissavBot;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.telegram.telegrambots.meta.TelegramBotsApi;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;
import org.telegram.telegrambots.updatesreceivers.DefaultBotSession;

@Slf4j
@Configuration
public class BotConfig {

    @Bean
    public TelegramBotsApi telegramBotsApi(MissavBot missavBot) throws TelegramApiException {
        TelegramBotsApi botsApi = new TelegramBotsApi(DefaultBotSession.class);
        try {
            botsApi.registerBot(missavBot);
            log.info("Telegram Bot æ³¨å†ŒæˆåŠŸ");
        } catch (TelegramApiException e) {
            log.error("Telegram Bot æ³¨å†Œå¤±è´¥", e);
            throw e;
        }
        return botsApi;
    }
}



com/missav/bot/common/config/MyMetaObjectHandler.java
package com.missav.bot.common.config;

import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
import org.apache.ibatis.reflection.MetaObject;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;

/**
 * MyBatis-Plus è‡ªåŠ¨å¡«å……å¤„ç†å™¨
 */
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {

    @Override
    public void insertFill(MetaObject metaObject) {
        this.strictInsertFill(metaObject, "createdTime", LocalDateTime.class, LocalDateTime.now());
    }

    @Override
    public void updateFill(MetaObject metaObject) {
        this.strictUpdateFill(metaObject, "updatedTime", LocalDateTime.class, LocalDateTime.now());
    }
}



com/missav/bot/common/entity/BaseEntity.java
package com.missav.bot.common.entity;

import com.baomidou.mybatisplus.annotation.FieldFill;
import com.baomidou.mybatisplus.annotation.TableField;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * åŸºç¡€å®ä½“ç±»ï¼ŒåŒ…å«å…¬å…±å­—æ®µ
 */
@Data
public abstract class BaseEntity implements Serializable {

    /**
     * åˆ›å»ºäººID
     */
    @TableField(fill = FieldFill.INSERT)
    private String createdId;

    /**
     * åˆ›å»ºäººå§“å
     */
    @TableField(fill = FieldFill.INSERT)
    private String createdName;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdTime;

    /**
     * æ›´æ–°äººID
     */
    @TableField(fill = FieldFill.UPDATE)
    private String updatedId;

    /**
     * æ›´æ–°äººå§“å
     */
    @TableField(fill = FieldFill.UPDATE)
    private String updatedName;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @TableField(fill = FieldFill.UPDATE)
    private LocalDateTime updatedTime;

    /**
     * å¤‡æ³¨
     */
    private String remark;
}



com/missav/bot/common/exception/GlobalExceptionHandler.java
package com.missav.bot.common.exception;

import com.missav.bot.common.Result;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * å¤„ç†å‚æ•°å¼‚å¸¸
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public Result<Void> handleIllegalArgumentException(IllegalArgumentException e) {
        log.error("å‚æ•°å¼‚å¸¸: {}", e.getMessage());
        return Result.error(400, e.getMessage());
    }

    /**
     * å¤„ç†ç©ºæŒ‡é’ˆå¼‚å¸¸
     */
    @ExceptionHandler(NullPointerException.class)
    public Result<Void> handleNullPointerException(NullPointerException e) {
        log.error("ç©ºæŒ‡é’ˆå¼‚å¸¸", e);
        return Result.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }

    /**
     * å¤„ç†è¿è¡Œæ—¶å¼‚å¸¸
     */
    @ExceptionHandler(RuntimeException.class)
    public Result<Void> handleRuntimeException(RuntimeException e) {
        log.error("è¿è¡Œæ—¶å¼‚å¸¸", e);
        return Result.error(500, e.getMessage());
    }

    /**
     * å¤„ç†é™æ€èµ„æºæœªæ‰¾åˆ°å¼‚å¸¸ï¼ˆé™çº§ä¸ºDEBUGï¼Œé¿å…æ—¥å¿—æ±¡æŸ“ï¼‰
     */
    @ExceptionHandler(org.springframework.web.servlet.resource.NoResourceFoundException.class)
    public void handleNoResourceFound(org.springframework.web.servlet.resource.NoResourceFoundException e) {
        log.debug("é™æ€èµ„æºæœªæ‰¾åˆ°: {}", e.getResourcePath());
    }

    /**
     * å¤„ç†æ–‡ä»¶ä¸Šä¼ è§£æå¼‚å¸¸ï¼ˆé™çº§ä¸ºDEBUGï¼Œé¿å…æ—¥å¿—æ±¡æŸ“ï¼‰
     */
    @ExceptionHandler(org.springframework.web.multipart.MultipartException.class)
    public void handleMultipartException(org.springframework.web.multipart.MultipartException e) {
        log.debug("æ–‡ä»¶ä¸Šä¼ è§£æå¤±è´¥ï¼ˆé€šå¸¸æ˜¯ Telegram å‘é€çš„éæ–‡æœ¬æ¶ˆæ¯ï¼‰: {}", e.getMessage());
    }

    /**
     * å¤„ç†é€šç”¨å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }
}



com/missav/bot/common/Result.java
package com.missav.bot.common.exception;

import com.missav.bot.common.Result;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * å¤„ç†å‚æ•°å¼‚å¸¸
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public Result<Void> handleIllegalArgumentException(IllegalArgumentException e) {
        log.error("å‚æ•°å¼‚å¸¸: {}", e.getMessage());
        return Result.error(400, e.getMessage());
    }

    /**
     * å¤„ç†ç©ºæŒ‡é’ˆå¼‚å¸¸
     */
    @ExceptionHandler(NullPointerException.class)
    public Result<Void> handleNullPointerException(NullPointerException e) {
        log.error("ç©ºæŒ‡é’ˆå¼‚å¸¸", e);
        return Result.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }

    /**
     * å¤„ç†è¿è¡Œæ—¶å¼‚å¸¸
     */
    @ExceptionHandler(RuntimeException.class)
    public Result<Void> handleRuntimeException(RuntimeException e) {
        log.error("è¿è¡Œæ—¶å¼‚å¸¸", e);
        return Result.error(500, e.getMessage());
    }

    /**
     * å¤„ç†é™æ€èµ„æºæœªæ‰¾åˆ°å¼‚å¸¸ï¼ˆé™çº§ä¸ºDEBUGï¼Œé¿å…æ—¥å¿—æ±¡æŸ“ï¼‰
     */
    @ExceptionHandler(org.springframework.web.servlet.resource.NoResourceFoundException.class)
    public void handleNoResourceFound(org.springframework.web.servlet.resource.NoResourceFoundException e) {
        log.debug("é™æ€èµ„æºæœªæ‰¾åˆ°: {}", e.getResourcePath());
    }

    /**
     * å¤„ç†æ–‡ä»¶ä¸Šä¼ è§£æå¼‚å¸¸ï¼ˆé™çº§ä¸ºDEBUGï¼Œé¿å…æ—¥å¿—æ±¡æŸ“ï¼‰
     */
    @ExceptionHandler(org.springframework.web.multipart.MultipartException.class)
    public void handleMultipartException(org.springframework.web.multipart.MultipartException e) {
        log.debug("æ–‡ä»¶ä¸Šä¼ è§£æå¤±è´¥ï¼ˆé€šå¸¸æ˜¯ Telegram å‘é€çš„éæ–‡æœ¬æ¶ˆæ¯ï¼‰: {}", e.getMessage());
    }

    /**
     * å¤„ç†é€šç”¨å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }
}



com/missav/bot/crawler/service/impl/CrawlerServiceImpl.java
package com.missav.bot.crawler.service.impl;

import com.missav.bot.crawler.CrawlResult;
import com.missav.bot.crawler.MissavCrawler;
import com.missav.bot.crawler.service.ICrawlerService;
import com.missav.bot.video.entity.Video;
import com.missav.bot.video.mapper.VideoMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class CrawlerServiceImpl implements ICrawlerService {

    private final MissavCrawler crawler;
    private final VideoMapper videoMapper;

    @Override
    @Transactional
    public List<Video> crawlAndSaveNewVideos() {
        return crawlAndSaveNewVideos(1);
    }

    @Override
    @Transactional
    public List<Video> crawlAndSaveNewVideos(int pages) {
        List<Video> crawledVideos = crawler.crawlNewVideos(pages);
        List<Video> newVideos = new ArrayList<>();
        int duplicateCount = 0;
        int invalidCount = 0;

        log.debug("å¼€å§‹å¤„ç†çˆ¬å–åˆ°çš„ {} ä¸ªè§†é¢‘", crawledVideos.size());

        // è¿‡æ»¤æ— æ•ˆè§†é¢‘
        List<Video> validVideos = new ArrayList<>();
        for (Video video : crawledVideos) {
            if (video.getCode() == null) {
                invalidCount++;
                log.debug("è·³è¿‡æ— æ•ˆè§†é¢‘ï¼ˆæ— ç•ªå·ï¼‰: {}", video.getTitle());
            } else {
                validVideos.add(video);
            }
        }

        if (validVideos.isEmpty()) {
            log.debug("æ²¡æœ‰æœ‰æ•ˆè§†é¢‘éœ€è¦å¤„ç†");
            log.info("æœ¬æ¬¡æŠ“å–å®Œæˆ - æ€»è®¡: {}, æ–°å¢: 0, é‡å¤: 0, æ— æ•ˆ: {}",
                crawledVideos.size(), invalidCount);
            return newVideos;
        }

        // æ‰¹é‡æ£€æŸ¥é‡å¤
        List<String> codes = validVideos.stream().map(Video::getCode).toList();
        List<String> existingCodes = videoMapper.selectExistingCodes(codes);
        java.util.Set<String> existingCodeSet = new java.util.HashSet<>(existingCodes);
        duplicateCount = existingCodes.size();

        // è¿‡æ»¤å‡ºæ–°è§†é¢‘
        for (Video video : validVideos) {
            if (existingCodeSet.contains(video.getCode())) {
                log.debug("è§†é¢‘å·²å­˜åœ¨ï¼Œè·³è¿‡: {}", video.getCode());
            } else {
                newVideos.add(video);
            }
        }

        if (newVideos.isEmpty()) {
            log.info("æœ¬æ¬¡æŠ“å–å®Œæˆ - æ€»è®¡: {}, æ–°å¢: 0, é‡å¤: {}, æ— æ•ˆ: {}",
                crawledVideos.size(), duplicateCount, invalidCount);
            return newVideos;
        }

        // è¡¥å……è¯¦æƒ…ä¿¡æ¯ï¼ˆå¦‚éœ€è¦ï¼‰
        for (Video video : newVideos) {
            if (video.getDetailUrl() != null &&
                (video.getActresses() == null || video.getPreviewUrl() == null)) {
                try {
                    Video detail = crawler.crawlVideoDetail(video.getDetailUrl());
                    if (detail != null) {
                        mergeVideoInfo(video, detail);
                    }
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
            video.setPushed(false);
        }

        // æ‰¹é‡æ’å…¥
        int actualInserted = 0;
        List<Video> insertedVideos = new ArrayList<>();
        for (Video video : newVideos) {
            try {
                videoMapper.insert(video);
                log.info("æ–°è§†é¢‘å…¥åº“: {} - {}", video.getCode(), video.getTitle());
                insertedVideos.add(video);
                actualInserted++;
            } catch (org.springframework.dao.DuplicateKeyException e) {
                log.warn("è§†é¢‘å·²å­˜åœ¨ï¼Œè·³è¿‡: {}", video.getCode());
                duplicateCount++;
            }
        }

        log.info("æœ¬æ¬¡æŠ“å–å®Œæˆ - æ€»è®¡: {}, æ–°å¢: {}, é‡å¤: {}, æ— æ•ˆ: {}",
            crawledVideos.size(), actualInserted, duplicateCount, invalidCount);

        return insertedVideos;
    }

    private void mergeVideoInfo(Video target, Video source) {
        if (source.getActresses() != null && target.getActresses() == null) {
            target.setActresses(source.getActresses());
        }
        if (source.getTags() != null && target.getTags() == null) {
            target.setTags(source.getTags());
        }
        if (source.getCoverUrl() != null && target.getCoverUrl() == null) {
            target.setCoverUrl(source.getCoverUrl());
        }
        if (source.getPreviewUrl() != null && target.getPreviewUrl() == null) {
            target.setPreviewUrl(source.getPreviewUrl());
        }
        if (source.getDuration() != null && target.getDuration() == null) {
            target.setDuration(source.getDuration());
        }
        if (source.getTitle() != null && target.getTitle() == null) {
            target.setTitle(source.getTitle());
        }
    }

    @Override
    public List<Video> getUnpushedVideos() {
        return videoMapper.selectUnpushedVideos();
    }

    @Override
    @Transactional
    public void markAsPushed(Long videoId) {
        Video video = videoMapper.selectById(videoId);
        if (video != null) {
            video.setPushed(true);
            videoMapper.updateById(video);
        }
    }

    @Override
    @Transactional
    public CrawlResult crawlByActor(String actorName, Integer limit) {
        log.debug("å¼€å§‹æŒ‰æ¼”å‘˜çˆ¬å–: {}, é™åˆ¶: {}", actorName, limit);
        List<Video> crawledVideos = crawler.crawlByActor(actorName, limit);
        return saveAndReturnResult(crawledVideos);
    }

    @Override
    @Transactional
    public Video crawlByCode(String code) {
        log.debug("å¼€å§‹æŒ‰ç•ªå·çˆ¬å–: {}", code);

        // å…ˆæ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²å­˜åœ¨
        if (videoMapper.existsByCode(code)) {
            log.debug("ç•ªå· {} å·²å­˜åœ¨äºæ•°æ®åº“", code);
            return videoMapper.selectByCode(code);
        }

        Video video = crawler.crawlByCode(code);
        if (video == null) {
            log.warn("æœªæ‰¾åˆ°ç•ªå·: {}", code);
            return null;
        }

        video.setPushed(false);
        videoMapper.insert(video);
        log.info("æ–°è§†é¢‘å…¥åº“: {} - {}", video.getCode(), video.getTitle());

        return video;
    }

    @Override
    @Transactional
    public CrawlResult crawlByKeyword(String keyword, Integer limit) {
        log.debug("å¼€å§‹æŒ‰å…³é”®è¯æœç´¢: {}, é™åˆ¶: {}", keyword, limit);
        List<Video> crawledVideos = crawler.crawlByKeyword(keyword, limit);
        return saveAndReturnResult(crawledVideos);
    }

    /**
     * ä¿å­˜çˆ¬å–çš„è§†é¢‘å¹¶è¿”å›çˆ¬å–ç»“æœï¼ˆå»é‡ï¼‰
     */
    private CrawlResult saveAndReturnResult(List<Video> crawledVideos) {
        List<Video> newVideos = new ArrayList<>();
        int duplicateCount = 0;
        int invalidCount = 0;

        log.debug("å¼€å§‹å¤„ç†çˆ¬å–åˆ°çš„ {} ä¸ªè§†é¢‘", crawledVideos.size());

        // è¿‡æ»¤æ— æ•ˆè§†é¢‘
        List<Video> validVideos = new ArrayList<>();
        for (Video video : crawledVideos) {
            if (video.getCode() == null) {
                invalidCount++;
                log.debug("è·³è¿‡æ— æ•ˆè§†é¢‘ï¼ˆæ— ç•ªå·ï¼‰: {}", video.getTitle());
            } else {
                validVideos.add(video);
            }
        }

        if (validVideos.isEmpty()) {
            log.debug("æ²¡æœ‰æœ‰æ•ˆè§†é¢‘éœ€è¦å¤„ç†");
            return new CrawlResult(newVideos, crawledVideos.size(), duplicateCount, invalidCount);
        }

        // æ‰¹é‡æ£€æŸ¥é‡å¤
        List<String> codes = validVideos.stream().map(Video::getCode).toList();
        List<String> existingCodes = videoMapper.selectExistingCodes(codes);
        java.util.Set<String> existingCodeSet = new java.util.HashSet<>(existingCodes);
        duplicateCount = existingCodes.size();

        // è¿‡æ»¤å‡ºæ–°è§†é¢‘
        for (Video video : validVideos) {
            if (existingCodeSet.contains(video.getCode())) {
                log.debug("è§†é¢‘å·²å­˜åœ¨ï¼Œè·³è¿‡: {}", video.getCode());
            } else {
                newVideos.add(video);
            }
        }

        if (newVideos.isEmpty()) {
            log.info("æœ¬æ¬¡æŠ“å–å®Œæˆ - æ€»è®¡: {}, æ–°å¢: 0, é‡å¤: {}, æ— æ•ˆ: {}",
                crawledVideos.size(), duplicateCount, invalidCount);
            return new CrawlResult(newVideos, crawledVideos.size(), duplicateCount, invalidCount);
        }

        // è¡¥å……è¯¦æƒ…ä¿¡æ¯ï¼ˆå¦‚éœ€è¦ï¼‰
        for (Video video : newVideos) {
            if (video.getDetailUrl() != null &&
                (video.getActresses() == null || video.getPreviewUrl() == null)) {
                try {
                    Video detail = crawler.crawlVideoDetail(video.getDetailUrl());
                    if (detail != null) {
                        mergeVideoInfo(video, detail);
                    }
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
            video.setPushed(false);
        }

        // æ‰¹é‡æ’å…¥
        int actualInserted = 0;
        List<Video> insertedVideos = new ArrayList<>();
        for (Video video : newVideos) {
            try {
                videoMapper.insert(video);
                log.info("æ–°è§†é¢‘å…¥åº“: {} - {}", video.getCode(), video.getTitle());
                insertedVideos.add(video);
                actualInserted++;
            } catch (org.springframework.dao.DuplicateKeyException e) {
                log.warn("è§†é¢‘å·²å­˜åœ¨ï¼Œè·³è¿‡: {}", video.getCode());
                duplicateCount++;
            }
        }

        log.info("æœ¬æ¬¡æŠ“å–å®Œæˆ - æ€»è®¡: {}, æ–°å¢: {}, é‡å¤: {}, æ— æ•ˆ: {}",
            crawledVideos.size(), actualInserted, duplicateCount, invalidCount);

        return new CrawlResult(insertedVideos, crawledVideos.size(), duplicateCount, invalidCount);
    }
}



com/missav/bot/crawler/service/ICrawlerService.java
package com.missav.bot.crawler.service;

import com.missav.bot.crawler.CrawlResult;
import com.missav.bot.video.entity.Video;

import java.util.List;

/**
 * çˆ¬è™«æœåŠ¡æ¥å£
 */
public interface ICrawlerService {

    /**
     * æŠ“å–å¹¶ä¿å­˜æ–°è§†é¢‘
     * @return æ–°å¢çš„è§†é¢‘åˆ—è¡¨
     */
    List<Video> crawlAndSaveNewVideos();

    /**
     * æŠ“å–å¹¶ä¿å­˜æŒ‡å®šé¡µæ•°çš„æ–°è§†é¢‘
     * @param pages é¡µæ•°
     * @return æ–°å¢çš„è§†é¢‘åˆ—è¡¨
     */
    List<Video> crawlAndSaveNewVideos(int pages);

    /**
     * è·å–æœªæ¨é€çš„è§†é¢‘
     * @return æœªæ¨é€çš„è§†é¢‘åˆ—è¡¨
     */
    List<Video> getUnpushedVideos();

    /**
     * æ ‡è®°è§†é¢‘ä¸ºå·²æ¨é€
     * @param videoId è§†é¢‘ID
     */
    void markAsPushed(Long videoId);

    /**
     * æŒ‰æ¼”å‘˜åçˆ¬å–ä½œå“
     * @param actorName æ¼”å‘˜å
     * @param limit é™åˆ¶æ•°é‡ï¼Œnull è¡¨ç¤ºå…¨éƒ¨
     * @return çˆ¬å–ç»“æœï¼ˆåŒ…å«æ–°å¢ã€é‡å¤ã€æ€»æ•°ç­‰ä¿¡æ¯ï¼‰
     */
    CrawlResult crawlByActor(String actorName, Integer limit);

    /**
     * æŒ‰ç•ªå·çˆ¬å–ä½œå“
     * @param code ç•ªå·
     * @return çˆ¬å–çš„è§†é¢‘ï¼Œä¸å­˜åœ¨è¿”å› null
     */
    Video crawlByCode(String code);

    /**
     * æŒ‰å…³é”®è¯æœç´¢çˆ¬å–
     * @param keyword å…³é”®è¯
     * @param limit é™åˆ¶æ•°é‡ï¼Œnull è¡¨ç¤ºå…¨éƒ¨
     * @return çˆ¬å–ç»“æœï¼ˆåŒ…å«æ–°å¢ã€é‡å¤ã€æ€»æ•°ç­‰ä¿¡æ¯ï¼‰
     */
    CrawlResult crawlByKeyword(String keyword, Integer limit);
}



com/missav/bot/crawler/CrawlResult.java
package com.missav.bot.crawler;

import com.missav.bot.video.entity.Video;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

/**
 * çˆ¬å–ç»“æœ
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class CrawlResult {
    /**
     * æ–°å¢çš„è§†é¢‘åˆ—è¡¨
     */
    private List<Video> newVideos;

    /**
     * çˆ¬å–æ€»æ•°
     */
    private int totalCrawled;

    /**
     * é‡å¤æ•°é‡
     */
    private int duplicateCount;

    /**
     * æ— æ•ˆæ•°é‡ï¼ˆæ— ç•ªå·ï¼‰
     */
    private int invalidCount;

    /**
     * è·å–æ–°å¢æ•°é‡
     */
    public int getNewCount() {
        return newVideos != null ? newVideos.size() : 0;
    }
}



com/missav/bot/crawler/MissavCrawler.java
package com.missav.bot.crawler;

import com.missav.bot.video.entity.Video;
import io.github.bonigarcia.wdm.WebDriverManager;
import lombok.extern.slf4j.Slf4j;
import okhttp3.*;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.time.Duration;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Slf4j
@Component
public class MissavCrawler {

    private static final String BASE_URL = "https://missav.ai";
    private static final String NEW_VIDEOS_URL = BASE_URL + "/new";

    private static final Pattern CODE_PATTERN = Pattern.compile("([A-Z]+-\\d+)", Pattern.CASE_INSENSITIVE);
    private static final Pattern DURATION_PATTERN = Pattern.compile("(\\d+)\\s*åˆ†");

    private final OkHttpClient httpClient;
    private final Map<String, List<Cookie>> cookieStore = new HashMap<>();
    private volatile LocalDateTime cookieInitTime = null;  // Cookie åˆå§‹åŒ–æ—¶é—´
    private static final Duration COOKIE_EXPIRE_DURATION = Duration.ofMinutes(10);  // Cookie æœ‰æ•ˆæœŸ10åˆ†é’Ÿ

    @Value("${crawler.user-agent:Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36}")
    private String userAgent;

    public MissavCrawler() {
        this.httpClient = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .readTimeout(30, TimeUnit.SECONDS)
                .writeTimeout(30, TimeUnit.SECONDS)
                .followRedirects(true)
                .cookieJar(new CookieJar() {
                    @Override
                    public void saveFromResponse(HttpUrl url, List<Cookie> cookies) {
                        cookieStore.put(url.host(), cookies);
                    }

                    @Override
                    public List<Cookie> loadForRequest(HttpUrl url) {
                        List<Cookie> cookies = cookieStore.get(url.host());
                        return cookies != null ? cookies : new ArrayList<>();
                    }
                })
                .build();
    }

    /**
     * åˆå§‹åŒ– Cookie - å¤šæ¬¡è¯·æ±‚å»ºç«‹ä¼šè¯
     */
    private void initCookies() {
        // æ£€æŸ¥ Cookie æ˜¯å¦éœ€è¦åˆ·æ–°
        boolean needRefresh = cookieStore.isEmpty()
                || cookieInitTime == null
                || Duration.between(cookieInitTime, LocalDateTime.now()).compareTo(COOKIE_EXPIRE_DURATION) > 0;

        if (!needRefresh) {
            log.debug("Cookie ä»ç„¶æœ‰æ•ˆï¼Œè·³è¿‡åˆå§‹åŒ–ï¼ˆå·²ä½¿ç”¨ {} åˆ†é’Ÿï¼‰",
                Duration.between(cookieInitTime, LocalDateTime.now()).toMinutes());
            return;
        }

        try {
            if (cookieStore.isEmpty()) {
                log.info("åˆå§‹åŒ– Cookieï¼ˆé¢„çƒ­ä¼šè¯ï¼‰...");
            } else {
                log.info("Cookie å·²è¿‡æœŸï¼Œé‡æ–°åˆå§‹åŒ–ï¼ˆä¸Šæ¬¡åˆå§‹åŒ–: {}ï¼‰", cookieInitTime);
                cookieStore.clear();  // æ¸…é™¤è¿‡æœŸ Cookie
            }

            // ç½‘ç«™éœ€è¦å¤šæ¬¡è¯·æ±‚æ‰èƒ½å»ºç«‹æœ‰æ•ˆä¼šè¯ï¼Œè¿›è¡Œ 2-3 æ¬¡é¢„çƒ­è¯·æ±‚
            for (int i = 1; i <= 3; i++) {
                fetchHtml(NEW_VIDEOS_URL + "?page=2");
                if (i < 3) {
                    Thread.sleep(1000); // è¯·æ±‚é—´éš” 1 ç§’
                }
            }

            cookieInitTime = LocalDateTime.now();  // è®°å½•åˆå§‹åŒ–æ—¶é—´
            log.info("Cookie åˆå§‹åŒ–å®Œæˆ");
        } catch (Exception e) {
            log.warn("Cookie åˆå§‹åŒ–å¤±è´¥", e);
        }
    }

    /**
     * æŠ“å–æœ€æ–°è§†é¢‘åˆ—è¡¨
     */
    public List<Video> crawlNewVideos() {
        return crawlNewVideos(1);
    }

    /**
     * æŠ“å–æŒ‡å®šé¡µæ•°çš„æœ€æ–°è§†é¢‘
     */
    public List<Video> crawlNewVideos(int pages) {
        List<Video> videos = new ArrayList<>();

        initCookies();

        for (int page = 1; page <= pages; page++) {
            try {
                String url = page == 1 ? NEW_VIDEOS_URL : NEW_VIDEOS_URL + "?page=" + page;
                log.info("æ­£åœ¨æŠ“å–: {}", url);

                String html = fetchHtml(url);
                if (html == null) {
                    log.warn("è·å–é¡µé¢å¤±è´¥: {}", url);
                    continue;
                }

                List<Video> pageVideos = parseVideoList(html);
                videos.addAll(pageVideos);
                log.info("ç¬¬{}é¡µæŠ“å–åˆ°{}ä¸ªè§†é¢‘", page, pageVideos.size());

                // é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                if (page < pages) {
                    Thread.sleep(2000);
                }
            } catch (Exception e) {
                log.error("æŠ“å–ç¬¬{}é¡µå¤±è´¥", page, e);
            }
        }

        return videos;
    }

    /**
     * æŠ“å–è§†é¢‘è¯¦æƒ…
     */
    public Video crawlVideoDetail(String detailUrl) {
        try {
            log.info("æ­£åœ¨æŠ“å–è§†é¢‘è¯¦æƒ…: {}", detailUrl);
            String html = fetchHtml(detailUrl);
            if (html == null) {
                log.warn("HTTP è¯·æ±‚å¤±è´¥ï¼Œé™çº§ä½¿ç”¨ Selenium");
                return crawlVideoDetailWithSelenium(detailUrl);
            }
            return parseVideoDetail(html, detailUrl);
        } catch (Exception e) {
            log.error("æŠ“å–è§†é¢‘è¯¦æƒ…å¤±è´¥: {}", detailUrl, e);
            return null;
        }
    }

    /**
     * ä½¿ç”¨ Selenium æŠ“å–è§†é¢‘è¯¦æƒ…
     */
    private Video crawlVideoDetailWithSelenium(String url) {
        WebDriver driver = null;
        try {
            WebDriverManager.chromedriver().setup();

            ChromeOptions options = new ChromeOptions();
            options.addArguments("--headless=new");
            options.addArguments("--no-sandbox");
            options.addArguments("--disable-dev-shm-usage");
            options.addArguments("--disable-gpu");
            options.addArguments("--user-agent=" + userAgent);

            driver = new ChromeDriver(options);
            driver.get(url);

            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));
            wait.until(ExpectedConditions.presenceOfElementLocated(By.tagName("body")));
            Thread.sleep(2000);

            String renderedHtml = driver.getPageSource();
            return parseVideoDetail(renderedHtml, url);

        } catch (Exception e) {
            log.error("Selenium æŠ“å–è§†é¢‘è¯¦æƒ…å¤±è´¥: {}", url, e);
            return null;
        } finally {
            if (driver != null) {
                driver.quit();
            }
        }
    }

    private String fetchHtml(String url) {
        // æ·»åŠ éšæœºå»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
        try {
            Thread.sleep(1000 + (long)(Math.random() * 2000)); // 1-3ç§’éšæœºå»¶è¿Ÿ
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }

        Request request = new Request.Builder()
                .url(url)
                .header("User-Agent", userAgent)
                .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8")
                .header("Accept-Language", "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7")
                // åˆ é™¤ Accept-Encodingï¼Œè®© OkHttp è‡ªåŠ¨å¤„ç†å‹ç¼©
                .header("Referer", "https://missav.ai/")
                .header("Connection", "keep-alive")
                .header("Cache-Control", "max-age=0")
                .build();

        try (Response response = httpClient.newCall(request).execute()) {
            log.debug("HTTP å“åº”çŠ¶æ€: {} - {}", response.code(), response.message());
            log.debug("æœ€ç»ˆ URL (é‡å®šå‘å): {}", response.request().url());

            if (!response.isSuccessful()) {
                log.warn("è¯·æ±‚å¤±è´¥: {} - {}", url, response.code());
                return null;
            }

            String html = response.body() != null ? response.body().string() : null;
            if (html != null) {
                log.debug("HTML é•¿åº¦: {} å­—ç¬¦", html.length());
                log.debug("HTML å‰500å­—ç¬¦: {}", html.substring(0, Math.min(500, html.length())));
            } else {
                log.warn("å“åº”ä½“ä¸ºç©º");
            }

            return html;
        } catch (IOException e) {
            log.error("è¯·æ±‚å¼‚å¸¸: {}", url, e);
            return null;
        }
    }

    /**
     * è§£æè§†é¢‘åˆ—è¡¨é¡µ
     */
    private List<Video> parseVideoList(String html) {
        List<Video> videos = new ArrayList<>();
        Document doc = Jsoup.parse(html);

        log.info("é¡µé¢æ ‡é¢˜: {}", doc.title());

        // é¦–å…ˆå°è¯•ä» script æ ‡ç­¾ä¸­æå– JSON æ•°æ®ï¼ˆå¤„ç†å®¢æˆ·ç«¯æ¸²æŸ“ï¼‰
        log.info("å¼€å§‹å°è¯• JSON æå–...");
        List<Video> jsonVideos = extractVideosFromJson(doc);
        if (!jsonVideos.isEmpty()) {
            log.info("âœ“ JSON æå–æˆåŠŸï¼Œè·å¾— {} ä¸ªè§†é¢‘", jsonVideos.size());
            return jsonVideos;
        }

        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿ HTML è§£æ
        log.info("âœ— JSON æå–å¤±è´¥ï¼ˆè¿”å› 0 ä¸ªè§†é¢‘ï¼‰ï¼Œé™çº§åˆ° HTML è§£æ");
        log.info("é¡µé¢åŒ…å«çš„ä¸»è¦ div ç±»: {}", doc.select("div[class]").stream()
            .limit(10)
            .map(e -> e.className())
            .distinct()
            .toList());

        // å°è¯•å¤šç§é€‰æ‹©å™¨
        Elements videoCards = doc.select("div.video-card, article.video, div[class*=thumbnail]");
        log.info("é€‰æ‹©å™¨1åŒ¹é…åˆ° {} ä¸ªå…ƒç´ ", videoCards.size());

        if (videoCards.isEmpty()) {
            videoCards = doc.select("div.group");
            log.info("é€‰æ‹©å™¨2(div.group)åŒ¹é…åˆ° {} ä¸ªå…ƒç´ ", videoCards.size());
        }

        if (videoCards.isEmpty()) {
            videoCards = doc.select("a[href*='/']");
            log.info("é€‰æ‹©å™¨3(a[href])åŒ¹é…åˆ° {} ä¸ªå…ƒç´ ", videoCards.size());

            if (!videoCards.isEmpty()) {
                videoCards = videoCards.stream()
                    .filter(e -> {
                        String href = e.attr("href");
                        return href != null && CODE_PATTERN.matcher(href).find();
                    })
                    .collect(Elements::new, Elements::add, Elements::addAll);
                log.info("è¿‡æ»¤ååŒ…å«ç•ªå·çš„é“¾æ¥: {} ä¸ª", videoCards.size());
            }
        }

        log.info("æœ€ç»ˆä½¿ç”¨çš„é€‰æ‹©å™¨åŒ¹é…åˆ° {} ä¸ªè§†é¢‘å¡ç‰‡", videoCards.size());

        if (videoCards.isEmpty()) {
            log.warn("æœªæ‰¾åˆ°ä»»ä½•è§†é¢‘å¡ç‰‡ï¼Œè¾“å‡ºHTMLå‰1000å­—ç¬¦ç”¨äºè°ƒè¯•:");
            log.warn(html.substring(0, Math.min(1000, html.length())));
        }

        for (Element card : videoCards) {
            try {
                Video video = parseVideoCard(card);
                if (video != null && video.getCode() != null) {
                    videos.add(video);
                } else {
                    log.warn("è§£æè§†é¢‘å¡ç‰‡å¤±è´¥ï¼Œæœªæå–åˆ°ç•ªå·ã€‚å…ƒç´ HTML: {}",
                        card.html().substring(0, Math.min(500, card.html().length())));
                    if (video != null) {
                        log.warn("æå–åˆ°çš„ä¿¡æ¯: title={}, detailUrl={}, code={}",
                            video.getTitle(), video.getDetailUrl(), video.getCode());
                    }
                }
            } catch (Exception e) {
                log.warn("è§£æè§†é¢‘å¡ç‰‡å¼‚å¸¸", e);
            }
        }

        return videos;
    }

    /**
     * ä½¿ç”¨ Selenium æå–å®¢æˆ·ç«¯æ¸²æŸ“çš„è§†é¢‘åˆ—è¡¨
     */
    private List<Video> extractVideosWithSelenium(String url) {
        log.warn("========== å¯åŠ¨æ— å¤´æµè§ˆå™¨æå–è§†é¢‘æ•°æ® ==========");
        WebDriver driver = null;
        try {
            WebDriverManager.chromedriver().setup();

            ChromeOptions options = new ChromeOptions();
            options.addArguments("--headless=new");
            options.addArguments("--no-sandbox");
            options.addArguments("--disable-dev-shm-usage");
            options.addArguments("--disable-gpu");
            options.addArguments("--user-agent=" + userAgent);

            driver = new ChromeDriver(options);
            driver.get(url);

            log.info("ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ...");
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));
            wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("div.group")));

            Thread.sleep(3000);

            log.info("æå–æ¸²æŸ“åçš„ HTML");
            String renderedHtml = driver.getPageSource();
            Document doc = Jsoup.parse(renderedHtml);

            List<Video> videos = new ArrayList<>();
            Elements videoCards = doc.select("div.group");
            log.info("Selenium æå–åˆ° {} ä¸ªè§†é¢‘å¡ç‰‡", videoCards.size());

            if (!videoCards.isEmpty()) {
                log.warn("========== ç¬¬ä¸€ä¸ªè§†é¢‘å¡ç‰‡çš„ HTMLï¼ˆç”¨äºè°ƒè¯•ï¼‰==========");
                log.warn(videoCards.first().html().substring(0, Math.min(1000, videoCards.first().html().length())));
                log.warn("========== ç¬¬ä¸€ä¸ªè§†é¢‘å¡ç‰‡çš„ HTML ç»“æŸ ==========");
            }

            for (Element card : videoCards) {
                try {
                    Video video = new Video();

                    Element link = card.selectFirst("a[href]");
                    if (link != null) {
                        String href = link.attr("href");
                        if (href != null && !href.isEmpty() && !href.equals("#") && !href.equals("javascript:;")) {
                            video.setDetailUrl(href.startsWith("http") ? href : BASE_URL + href);
                            String code = extractCode(href);
                            if (code == null) {
                                code = extractCodeFromUrl(href);
                            }
                            video.setCode(code);
                        }
                    }

                    Element img = card.selectFirst("img[src], img[data-src]");
                    if (img != null) {
                        String coverUrl = extractImageUrl(img);
                        if (coverUrl != null && !coverUrl.isEmpty()) {
                            video.setCoverUrl(coverUrl);
                        }
                    }

                    if (video.getCode() != null) {
                        videos.add(video);
                    }
                } catch (Exception e) {
                    log.warn("è§£æè§†é¢‘å¡ç‰‡å¼‚å¸¸", e);
                }
            }

            log.warn("âœ“ Selenium æå–å®Œæˆï¼Œè·å¾— {} ä¸ªè§†é¢‘", videos.size());
            return videos;

        } catch (Exception e) {
            log.error("Selenium æå–å¤±è´¥", e);
            return new ArrayList<>();
        } finally {
            if (driver != null) {
                driver.quit();
            }
            log.warn("========== æ— å¤´æµè§ˆå™¨å·²å…³é—­ ==========");
        }
    }

    /**
     * è§£æè§†é¢‘å¡ç‰‡
     */
    private Video parseVideoCard(Element card) {
        Video video = new Video();

        // æå–é“¾æ¥
        Element link = card.selectFirst("a[href*=missav]");
        if (link == null) {
            link = card.selectFirst("a");
        }
        if (link != null) {
            video.setDetailUrl(link.attr("abs:href"));
        }

        // æå–æ ‡é¢˜
        Element titleEl = card.selectFirst("h3, h4, .title, [class*=title]");
        if (titleEl != null) {
            video.setTitle(titleEl.text().trim());
        }

        // ä»æ ‡é¢˜æˆ–é“¾æ¥ä¸­æå–ç•ªå·
        String code = extractCode(video.getTitle());
        if (code == null && video.getDetailUrl() != null) {
            code = extractCode(video.getDetailUrl());
        }

        // å¦‚æœä»ç„¶æ²¡æœ‰æå–åˆ°ç•ªå·ï¼Œå°è¯•ä»URLè·¯å¾„ä¸­æå–ä½œä¸ºå¤‡ç”¨æ ‡è¯†
        if (code == null && video.getDetailUrl() != null) {
            code = extractCodeFromUrl(video.getDetailUrl());
        }
        video.setCode(code);

        // æå–å°é¢å›¾
        Element img = card.selectFirst("img");
        if (img != null) {
            String coverUrl = extractImageUrl(img);
            if (coverUrl != null && !coverUrl.isEmpty()) {
                video.setCoverUrl(coverUrl);
            }
        }

        // æå–æ—¶é•¿
        Element durationEl = card.selectFirst(".duration, [class*=duration], span:contains(åˆ†)");
        if (durationEl != null) {
            video.setDuration(extractDuration(durationEl.text()));
        }

        return video;
    }

    /**
     * è§£æè§†é¢‘è¯¦æƒ…é¡µ
     */
    private Video parseVideoDetail(String html, String detailUrl) {
        Document doc = Jsoup.parse(html);
        Video video = new Video();
        video.setDetailUrl(detailUrl);

        // æå–æ ‡é¢˜
        Element titleEl = doc.selectFirst("h1, .video-title, [class*=title]");
        if (titleEl != null) {
            video.setTitle(titleEl.text().trim());
        }

        // æå–ç•ªå·
        video.setCode(extractCode(video.getTitle()));
        if (video.getCode() == null) {
            video.setCode(extractCode(detailUrl));
        }

        // æå–æ¼”å‘˜
        Elements actressEls = doc.select("a[href*=actress], a[href*=actor], .actress");
        if (!actressEls.isEmpty()) {
            List<String> actresses = new ArrayList<>();
            for (Element el : actressEls) {
                actresses.add(el.text().trim());
            }
            video.setActresses(String.join(", ", actresses));
        }

        // æå–æ ‡ç­¾
        Elements tagEls = doc.select("a[href*=tag], a[href*=genre], .tag");
        if (!tagEls.isEmpty()) {
            List<String> tags = new ArrayList<>();
            for (Element el : tagEls) {
                tags.add(el.text().trim());
            }
            video.setTags(String.join(", ", tags));
        }

        // æå–å°é¢å›¾
        Element coverEl = doc.selectFirst("meta[property=og:image], img.cover, .video-cover img");
        if (coverEl != null) {
            video.setCoverUrl(coverEl.attr("content"));
            if (video.getCoverUrl().isEmpty()) {
                video.setCoverUrl(coverEl.attr("src"));
            }
        }

        // æå–é¢„è§ˆè§†é¢‘ - å°è¯•å¤šç§æ–¹å¼
        Element videoEl = doc.selectFirst("video");
        if (videoEl != null) {
            // å°è¯•ä»videoæ ‡ç­¾çš„å„ç§å±æ€§ä¸­è·å–
            String previewUrl = videoEl.attr("data-src");
            if (previewUrl.isEmpty()) previewUrl = videoEl.attr("src");
            if (previewUrl.isEmpty()) {
                Element source = videoEl.selectFirst("source");
                if (source != null) {
                    previewUrl = source.attr("src");
                    if (previewUrl.isEmpty()) previewUrl = source.attr("data-src");
                }
            }
            if (!previewUrl.isEmpty()) {
                video.setPreviewUrl(previewUrl);
            }
        }

        // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°,å°è¯•ä»scriptæ ‡ç­¾ä¸­æå–
        if (video.getPreviewUrl() == null || video.getPreviewUrl().isEmpty()) {
            Elements scripts = doc.select("script");
            for (Element script : scripts) {
                String scriptText = script.html();
                if (scriptText.contains(".mp4") || scriptText.contains("preview")) {
                    // å°è¯•æå–URLæ¨¡å¼
                    int start = scriptText.indexOf("https://");
                    if (start != -1) {
                        int end = scriptText.indexOf(".mp4", start);
                        if (end != -1) {
                            String url = scriptText.substring(start, end + 4);
                            video.setPreviewUrl(url);
                            break;
                        }
                    }
                }
            }
        }

        // æå–æ—¶é•¿
        Element durationEl = doc.selectFirst(".duration, [class*=duration], span:contains(åˆ†é’Ÿ)");
        if (durationEl != null) {
            video.setDuration(extractDuration(durationEl.text()));
        }

        return video;
    }

    /**
     * æŒ‰æ¼”å‘˜åçˆ¬å–ä½œå“
     */
    public List<Video> crawlByActor(String actorName, Integer limit) {
        List<Video> videos = new ArrayList<>();
        int page = 1;
        // å‡è®¾æ¯é¡µå¹³å‡ 12 ä¸ªè§†é¢‘ï¼Œè®¡ç®—éœ€è¦çš„æœ€å¤§é¡µæ•°ï¼ˆå‘ä¸Šå–æ•´å¹¶å¤šçˆ¬1é¡µä»¥ç¡®ä¿è¶³å¤Ÿï¼‰
        int maxPages = limit != null ? ((limit + 11) / 12 + 1) : Integer.MAX_VALUE;

        try {
            initCookies();
            String encodedName = URLEncoder.encode(actorName, StandardCharsets.UTF_8);
            while (page <= maxPages) {
                String url = BASE_URL + "/actresses/" + encodedName + (page > 1 ? "?page=" + page : "");
                log.info("æ­£åœ¨æŠ“å–æ¼”å‘˜ä½œå“: {}", url);

                String html = fetchHtml(url);
                if (html == null) {
                    break;
                }

                List<Video> pageVideos = parseVideoList(html);
                if (pageVideos.isEmpty()) {
                    break;
                }

                videos.addAll(pageVideos);
                log.info("æ¼”å‘˜ {} ç¬¬{}é¡µæŠ“å–åˆ°{}ä¸ªè§†é¢‘ï¼Œå½“å‰æ€»æ•°: {}", actorName, page, pageVideos.size(), videos.size());

                if (limit != null && videos.size() >= limit) {
                    videos = videos.subList(0, limit);
                    log.info("å·²è¾¾åˆ°é™åˆ¶æ•°é‡ {}ï¼Œåœæ­¢æŠ“å–", limit);
                    break;
                }

                page++;
                Thread.sleep(2000);
            }
        } catch (Exception e) {
            log.error("æŠ“å–æ¼”å‘˜ {} çš„ä½œå“å¤±è´¥", actorName, e);
        }

        log.info("æ¼”å‘˜ä½œå“æŠ“å–å®Œæˆï¼Œå…±æŠ“å– {} ä¸ªè§†é¢‘", videos.size());
        return videos;
    }

    /**
     * æŒ‰ç•ªå·çˆ¬å–ä½œå“
     */
    public Video crawlByCode(String code) {
        try {
            // MissAV çš„ç•ªå·è¯¦æƒ…é¡µ URL æ ¼å¼é€šå¸¸æ˜¯ /ç•ªå·
            String url = BASE_URL + "/" + code;
            log.info("æ­£åœ¨æŒ‰ç•ªå·çˆ¬å–: {}", url);

            String html = fetchHtml(url);
            if (html == null) {
                return null;
            }

            Video video = parseVideoDetail(html, url);
            if (video != null && video.getCode() == null) {
                video.setCode(code.toUpperCase());
            }

            return video;
        } catch (Exception e) {
            log.error("æŒ‰ç•ªå· {} çˆ¬å–å¤±è´¥", code, e);
            return null;
        }
    }

    /**
     * æŒ‰å…³é”®è¯æœç´¢çˆ¬å–
     */
    public List<Video> crawlByKeyword(String keyword, Integer limit) {
        List<Video> videos = new ArrayList<>();
        int page = 1;
        int maxPages = limit != null ? ((limit + 11) / 12 + 1) : Integer.MAX_VALUE;

        try {
            initCookies();
            String encodedKeyword = URLEncoder.encode(keyword, StandardCharsets.UTF_8);
            while (page <= maxPages) {
                String url = BASE_URL + "/search/" + encodedKeyword + (page > 1 ? "?page=" + page : "");
                log.info("æ­£åœ¨æœç´¢å…³é”®è¯: {}", url);

                String html = fetchHtml(url);
                if (html == null) {
                    break;
                }

                List<Video> pageVideos = parseVideoList(html);

                // å¦‚æœç¬¬ä¸€é¡µè§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ Selenium
                if (pageVideos.isEmpty() && page == 1) {
                    log.warn("ç¬¬ä¸€é¡µ HTML è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ Selenium æ— å¤´æµè§ˆå™¨");
                    pageVideos = extractVideosWithSelenium(url);
                }

                if (pageVideos.isEmpty()) {
                    break;
                }

                videos.addAll(pageVideos);
                log.info("å…³é”®è¯ {} ç¬¬{}é¡µæŠ“å–åˆ°{}ä¸ªè§†é¢‘ï¼Œå½“å‰æ€»æ•°: {}", keyword, page, pageVideos.size(), videos.size());

                if (limit != null && videos.size() >= limit) {
                    videos = videos.subList(0, limit);
                    log.info("å·²è¾¾åˆ°é™åˆ¶æ•°é‡ {}ï¼Œåœæ­¢æŠ“å–", limit);
                    break;
                }

                page++;
                Thread.sleep(2000);
            }
        } catch (Exception e) {
            log.error("æœç´¢å…³é”®è¯ {} å¤±è´¥", keyword, e);
        }

        log.info("å…³é”®è¯æœç´¢å®Œæˆï¼Œå…±æŠ“å– {} ä¸ªè§†é¢‘", videos.size());
        return videos;
    }

    /**
     * ä» img å…ƒç´ ä¸­æå–çœŸå®çš„å›¾ç‰‡ URL
     * å°è¯•å¤šä¸ªå¯èƒ½çš„å±æ€§ï¼Œè¿‡æ»¤æ‰ base64 å ä½ç¬¦
     */
    private String extractImageUrl(Element img) {
        if (img == null) {
            return null;
        }

        // æŒ‰ä¼˜å…ˆçº§å°è¯•å¤šä¸ªå±æ€§
        String[] attributes = {"data-original", "data-lazy-src", "data-src", "srcset", "src"};

        for (String attr : attributes) {
            String url = img.attr(attr);
            if (url != null && !url.isEmpty() && !url.startsWith("data:")) {
                // å¦‚æœæ˜¯ srcsetï¼Œå–ç¬¬ä¸€ä¸ª URL
                if (attr.equals("srcset") && url.contains(" ")) {
                    url = url.split("\\s+")[0];
                }
                // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ HTTP/HTTPS URL
                if (url.startsWith("http://") || url.startsWith("https://") || url.startsWith("/")) {
                    return url;
                }
            }
        }

        return null;
    }

    /**
     * ä»æ–‡æœ¬ä¸­æå–ç•ªå·
     */
    private String extractCode(String text) {
        if (text == null || text.isEmpty()) {
            return null;
        }
        Matcher matcher = CODE_PATTERN.matcher(text);
        if (matcher.find()) {
            return matcher.group(1).toUpperCase();
        }
        return null;
    }

    /**
     * ä»URLè·¯å¾„ä¸­æå–æ ‡è¯†ç¬¦ä½œä¸ºå¤‡ç”¨ç•ªå·
     * ä¾‹å¦‚: https://missav.ai/xxx/yyy/zzz â†’ zzz
     */
    private String extractCodeFromUrl(String url) {
        if (url == null || url.isEmpty()) {
            return null;
        }
        try {
            // ç§»é™¤æŸ¥è¯¢å‚æ•°å’Œé”šç‚¹
            String path = url.split("\\?")[0].split("#")[0];
            // ç§»é™¤æœ«å°¾çš„æ–œæ 
            if (path.endsWith("/")) {
                path = path.substring(0, path.length() - 1);
            }
            // æå–æœ€åä¸€æ®µè·¯å¾„
            String[] parts = path.split("/");
            if (parts.length > 0) {
                String lastPart = parts[parts.length - 1];
                // å¦‚æœæœ€åä¸€æ®µä¸ä¸ºç©ºï¼Œä½¿ç”¨å®ƒä½œä¸ºæ ‡è¯†ç¬¦
                if (!lastPart.isEmpty()) {
                    log.debug("ä»URLæå–å¤‡ç”¨æ ‡è¯†ç¬¦: {} -> {}", url, lastPart);
                    return lastPart.toUpperCase();
                }
            }
        } catch (Exception e) {
            log.warn("ä»URLæå–æ ‡è¯†ç¬¦å¤±è´¥: {}", url, e);
        }
        return null;
    }

    /**
     * ä»é¡µé¢ script æ ‡ç­¾ä¸­æå– JSON æ•°æ®ï¼ˆå¤„ç†å®¢æˆ·ç«¯æ¸²æŸ“é¡µé¢ï¼‰
     */
    private List<Video> extractVideosFromJson(Document doc) {
        List<Video> videos = new ArrayList<>();

        // æŸ¥æ‰¾æ‰€æœ‰ script æ ‡ç­¾
        Elements scripts = doc.select("script");
        log.info("æ‰¾åˆ° {} ä¸ª script æ ‡ç­¾", scripts.size());

        int scriptIndex = 0;
        Element obfuscatedScript = null;
        int obfuscatedScriptIndex = -1;

        for (Element script : scripts) {
            String scriptContent = script.html();
            scriptIndex++;

            // æ£€æµ‹æ··æ·†ä»£ç ï¼ˆeval + function packingï¼‰
            boolean isObfuscated = scriptContent.contains("eval(function(p,a,c,k,e,d)");
            boolean hasVideoData = scriptContent.contains("dvd_id") || scriptContent.contains("uuid");

            // è¾“å‡º script ä¿¡æ¯
            if (scriptContent.length() > 0) {
                String prefix = isObfuscated ? "ã€æ··æ·†ä»£ç ã€‘" : "";
                log.info("{}Script #{} (é•¿åº¦: {} å­—ç¬¦) å‰200å­—ç¬¦: {}",
                    prefix,
                    scriptIndex,
                    scriptContent.length(),
                    scriptContent.substring(0, Math.min(200, scriptContent.length())));

                // å¦‚æœæ˜¯æ··æ·†ä»£ç ä¸”é•¿åº¦è¶…è¿‡3000å­—ç¬¦ï¼Œä¿å­˜å¼•ç”¨ï¼ˆå¯èƒ½åŒ…å«è§†é¢‘æ•°æ®ï¼‰
                if (isObfuscated && scriptContent.length() > 3000) {
                    obfuscatedScript = script;
                    obfuscatedScriptIndex = scriptIndex;
                    log.warn("æ£€æµ‹åˆ°å¤§å‹æ··æ·†ä»£ç  Script #{}ï¼Œç¨åè¾“å‡ºå®Œæ•´å†…å®¹", scriptIndex);
                }
            } else {
                log.info("Script #{} ä¸ºç©º", scriptIndex);
            }

            // æŸ¥æ‰¾å¯èƒ½åŒ…å«è§†é¢‘æ•°æ®çš„ JSON
            if (hasVideoData) {
                log.info("å‘ç°å¯èƒ½åŒ…å«è§†é¢‘æ•°æ®çš„ script æ ‡ç­¾ï¼ˆé•¿åº¦: {} å­—ç¬¦ï¼‰", scriptContent.length());

                try {
                    // å°è¯•æå– JSON æ•°æ®
                    // æ¨¡å¼1: window.xxx = {...}
                    String jsonPattern1 = "window\\.[\\w_]+\\s*=\\s*(\\{.*?\\});?$";
                    java.util.regex.Pattern p1 = java.util.regex.Pattern.compile(jsonPattern1, java.util.regex.Pattern.DOTALL);
                    Matcher m1 = p1.matcher(scriptContent);

                    if (m1.find()) {
                        String jsonStr = m1.group(1);
                        log.info("æå–åˆ° JSON å­—ç¬¦ä¸²ï¼ˆå‰200å­—ç¬¦ï¼‰: {}",
                            jsonStr.substring(0, Math.min(200, jsonStr.length())));

                        // TODO: ä½¿ç”¨ JSON è§£æåº“ï¼ˆå¦‚ Jackson æˆ– Gsonï¼‰è§£ææ•°æ®
                        // è¿™é‡Œå…ˆç®€å•æå– dvd_id
                        videos.addAll(parseJsonToVideos(jsonStr));
                    } else {
                        log.info("æœªåŒ¹é…åˆ° window.xxx = {{...}} æ¨¡å¼");
                    }
                } catch (Exception e) {
                    log.warn("JSON æå–å¤±è´¥", e);
                }
            }
        }

        // å¦‚æœå‘ç°æ··æ·†ä»£ç ï¼Œè¾“å‡ºå®Œæ•´å†…å®¹ç”¨äºåˆ†æ
        if (obfuscatedScript != null) {
            String fullContent = obfuscatedScript.html();
            log.warn("========== æ··æ·†ä»£ç  Script #{} å®Œæ•´å†…å®¹å¼€å§‹ ==========", obfuscatedScriptIndex);
            log.warn(fullContent);
            log.warn("========== æ··æ·†ä»£ç  Script #{} å®Œæ•´å†…å®¹ç»“æŸ ==========", obfuscatedScriptIndex);

            // å°è¯•åˆ†ææ··æ·†ä»£ç çš„ç‰¹å¾
            analyzeObfuscatedCode(fullContent, obfuscatedScriptIndex);
        }

        log.info("JSON æå–å®Œæˆï¼Œå…±è·å¾— {} ä¸ªè§†é¢‘", videos.size());
        return videos;
    }

    /**
     * åˆ†ææ··æ·†ä»£ç ï¼Œå°è¯•æ‰¾åˆ°è§†é¢‘æ•°æ®çš„åŠ è½½æ–¹å¼
     */
    private void analyzeObfuscatedCode(String code, int scriptIndex) {
        log.info("========== å¼€å§‹åˆ†ææ··æ·†ä»£ç  Script #{} ==========", scriptIndex);

        // æ£€æµ‹æ˜¯å¦åŒ…å« fetch/axios/ajax ç­‰ç½‘ç»œè¯·æ±‚
        if (code.contains("fetch(") || code.contains("axios") || code.contains("$.ajax") || code.contains("XMLHttpRequest")) {
            log.warn("âœ“ æ£€æµ‹åˆ°ç½‘ç»œè¯·æ±‚ç›¸å…³ä»£ç ï¼ˆfetch/axios/ajax/XMLHttpRequestï¼‰");

            // å°è¯•æå– API URL æ¨¡å¼
            Pattern urlPattern = Pattern.compile("(['\"])(https?://[^'\"]+|/api/[^'\"]+)\\1");
            Matcher matcher = urlPattern.matcher(code);
            Set<String> urls = new HashSet<>();
            while (matcher.find()) {
                String url = matcher.group(2);
                if (url.contains("api") || url.contains("search") || url.contains("video")) {
                    urls.add(url);
                }
            }
            if (!urls.isEmpty()) {
                log.warn("âœ“ å‘ç°å¯èƒ½çš„ API ç«¯ç‚¹:");
                urls.forEach(url -> log.warn("  - {}", url));
            }
        }

        // æ£€æµ‹ Alpine.js æˆ– Vue.js ç›¸å…³ä»£ç 
        if (code.contains("Alpine") || code.contains("x-data") || code.contains("Vue")) {
            log.warn("âœ“ æ£€æµ‹åˆ° Alpine.js/Vue.js æ¡†æ¶ä»£ç ");
        }

        // æ£€æµ‹æ•°æ®æŒ‚è½½åˆ° window å¯¹è±¡
        Pattern windowPattern = Pattern.compile("window\\.([\\w_]+)\\s*=");
        Matcher windowMatcher = windowPattern.matcher(code);
        Set<String> windowVars = new HashSet<>();
        while (windowMatcher.find()) {
            windowVars.add(windowMatcher.group(1));
        }
        if (!windowVars.isEmpty()) {
            log.warn("âœ“ å‘ç°æŒ‚è½½åˆ° window çš„å˜é‡:");
            windowVars.forEach(var -> log.warn("  - window.{}", var));
        }

        // æ£€æµ‹è§£æ··æ·†åçš„å‡½æ•°è°ƒç”¨ç‰¹å¾
        if (code.contains("eval(function(p,a,c,k,e,d)")) {
            log.warn("âœ“ ç¡®è®¤ä¸º eval å‡½æ•°æ‰“åŒ…æ··æ·†");
            log.warn("  å»ºè®®æ–¹æ¡ˆ:");
            log.warn("  1. åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œæ­¤ä»£ç å¹¶æ‹¦æˆªç½‘ç»œè¯·æ±‚ï¼Œæ‰¾åˆ°çœŸå® API");
            log.warn("  2. ä½¿ç”¨æ— å¤´æµè§ˆå™¨ï¼ˆSelenium/Playwrightï¼‰æ‰§è¡Œ JavaScript å¹¶æå–æ¸²æŸ“åçš„ DOM");
            log.warn("  3. åå‘åˆ†ææ··æ·†ä»£ç ï¼Œæå–å…³é”®å˜é‡å’Œå‡½æ•°");
        }

        log.info("========== æ··æ·†ä»£ç åˆ†æå®Œæˆ ==========");
    }

    /**
     * è§£æ JSON å­—ç¬¦ä¸²ä¸ºè§†é¢‘åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
     */
    private List<Video> parseJsonToVideos(String jsonStr) {
        List<Video> videos = new ArrayList<>();

        // ç®€å•çš„æ­£åˆ™æå–ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
        // æ›´å¥½çš„åšæ³•æ˜¯ä½¿ç”¨ Jackson/Gsonï¼Œä½†éœ€è¦å…ˆåˆ†æå…·ä½“çš„ JSON ç»“æ„
        Pattern dvdIdPattern = Pattern.compile("\"dvd_id\"\\s*:\\s*\"([^\"]+)\"");
        Pattern uuidPattern = Pattern.compile("\"uuid\"\\s*:\\s*\"([^\"]+)\"");

        Matcher matcher = dvdIdPattern.matcher(jsonStr);
        while (matcher.find()) {
            String dvdId = matcher.group(1);
            Video video = new Video();
            video.setCode(dvdId.toUpperCase());
            video.setDetailUrl(BASE_URL + "/" + dvdId);
            videos.add(video);
            log.debug("ä» JSON æå–åˆ°è§†é¢‘: {}", dvdId);
        }

        // å¦‚æœæ²¡æœ‰ dvd_idï¼Œå°è¯• uuid
        if (videos.isEmpty()) {
            matcher = uuidPattern.matcher(jsonStr);
            while (matcher.find()) {
                String uuid = matcher.group(1);
                Video video = new Video();
                video.setCode(uuid.toUpperCase());
                video.setDetailUrl(BASE_URL + "/" + uuid);
                videos.add(video);
                log.debug("ä» JSON æå–åˆ°è§†é¢‘ï¼ˆUUIDï¼‰: {}", uuid);
            }
        }

        return videos;
    }

    /**
     * ä»æ–‡æœ¬ä¸­æå–æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
     */
    private Integer extractDuration(String text) {
        if (text == null || text.isEmpty()) {
            return null;
        }
        Matcher matcher = DURATION_PATTERN.matcher(text);
        if (matcher.find()) {
            return Integer.parseInt(matcher.group(1));
        }
        // å°è¯•ç›´æ¥è§£ææ•°å­—
        try {
            return Integer.parseInt(text.replaceAll("\\D", ""));
        } catch (NumberFormatException e) {
            return null;
        }
    }
}



com/missav/bot/push/controller/PushRecordController.java
package com.missav.bot.push.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.missav.bot.common.Result;
import com.missav.bot.push.entity.PushRecord;
import com.missav.bot.push.mapper.PushRecordMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/push-records")
@RequiredArgsConstructor
public class PushRecordController {

    private final PushRecordMapper pushRecordMapper;

    @GetMapping
    public Result<IPage<PushRecord>> list(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer size) {
        Page<PushRecord> pageParam = new Page<>(page, size);
        IPage<PushRecord> result = pushRecordMapper.selectPage(pageParam, null);
        return Result.success(result);
    }

    @GetMapping("/{id}")
    public Result<PushRecord> getById(@PathVariable Long id) {
        PushRecord record = pushRecordMapper.selectById(id);
        if (record == null) {
            return Result.error(404, "æ¨é€è®°å½•ä¸å­˜åœ¨");
        }
        return Result.success(record);
    }

    @GetMapping("/chat/{chatId}")
    public Result<List<PushRecord>> getByChatId(@PathVariable Long chatId) {
        List<PushRecord> records = pushRecordMapper.selectByChatIdOrderByPushedAtDesc(chatId);
        return Result.success(records);
    }

    @GetMapping("/video/{videoId}")
    public Result<List<PushRecord>> getByVideoId(@PathVariable Long videoId) {
        List<PushRecord> records = pushRecordMapper.selectByVideoId(videoId);
        return Result.success(records);
    }

    @GetMapping("/failed")
    public Result<List<PushRecord>> getFailed() {
        List<PushRecord> records = pushRecordMapper.selectByStatusOrderByPushedAtAsc(
                PushRecord.PushStatus.FAILED.name());
        return Result.success(records);
    }
}



com/missav/bot/push/entity/PushRecord.java
package com.missav.bot.push.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.missav.bot.common.entity.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import lombok.Builder;

import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(callSuper = true)
@TableName("push_records")
public class PushRecord extends BaseEntity {

    @TableId(type = IdType.AUTO)
    private Long id;

    private Long videoId;
    private Long chatId;
    private PushStatus status;
    private String failReason;
    private LocalDateTime pushedAt;
    private Integer messageId;

    public enum PushStatus {
        SUCCESS,
        FAILED
    }
}



com/missav/bot/push/mapper/PushRecordMapper.java
package com.missav.bot.push.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.missav.bot.common.entity.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import lombok.Builder;

import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(callSuper = true)
@TableName("push_records")
public class PushRecord extends BaseEntity {

    @TableId(type = IdType.AUTO)
    private Long id;

    private Long videoId;
    private Long chatId;
    private PushStatus status;
    private String failReason;
    private LocalDateTime pushedAt;
    private Integer messageId;

    public enum PushStatus {
        SUCCESS,
        FAILED
    }
}



com/missav/bot/push/service/impl/PushServiceImpl.java
package com.missav.bot.push.service.impl;

import com.missav.bot.push.entity.PushRecord;
import com.missav.bot.push.mapper.PushRecordMapper;
import com.missav.bot.push.service.IPushService;
import com.missav.bot.subscription.entity.Subscription;
import com.missav.bot.subscription.service.ISubscriptionService;
import com.missav.bot.telegram.TelegramMessageService;
import com.missav.bot.video.entity.Video;
import com.missav.bot.crawler.service.ICrawlerService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Slf4j
@Service
@RequiredArgsConstructor
public class PushServiceImpl implements IPushService {

    private final TelegramMessageService telegramMessageService;
    private final ISubscriptionService subscriptionService;
    private final ICrawlerService crawlerService;
    private final PushRecordMapper pushRecordMapper;

    @Override
    @Transactional
    public void pushVideoToSubscribers(Video video) {
        // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰è®¢é˜…
        List<Subscription> allSubscriptions = subscriptionService.list();
        if (allSubscriptions.isEmpty()) {
            crawlerService.markAsPushed(video.getId());
            log.debug("æ²¡æœ‰ä»»ä½•è®¢é˜…ï¼Œè§†é¢‘ {} å·²æ ‡è®°ä¸ºå·²æ¨é€", video.getCode());
            return;
        }

        // åœ¨å†…å­˜ä¸­åŒ¹é…è®¢é˜…ï¼Œæ”¶é›†æ‰€æœ‰éœ€è¦æ¨é€çš„ chatId
        Set<Long> targetChatIds = new HashSet<>();

        for (Subscription sub : allSubscriptions) {
            boolean matches = false;

            if (sub.getType() == Subscription.SubscriptionType.ALL) {
                matches = true;
            } else if (sub.getType() == Subscription.SubscriptionType.ACTRESS && video.getActresses() != null) {
                String[] actresses = video.getActresses().split(",\\s*");
                for (String actress : actresses) {
                    if (actress.trim().equals(sub.getKeyword())) {
                        matches = true;
                        break;
                    }
                }
            } else if (sub.getType() == Subscription.SubscriptionType.TAG && video.getTags() != null) {
                String[] tags = video.getTags().split(",\\s*");
                for (String tag : tags) {
                    if (tag.trim().equals(sub.getKeyword())) {
                        matches = true;
                        break;
                    }
                }
            }

            if (matches) {
                targetChatIds.add(sub.getChatId());
            }
        }

        if (targetChatIds.isEmpty()) {
            crawlerService.markAsPushed(video.getId());
            log.debug("è§†é¢‘ {} æ²¡æœ‰åŒ¹é…çš„è®¢é˜…è€…ï¼Œå·²æ ‡è®°ä¸ºå·²æ¨é€", video.getCode());
            return;
        }

        // æ‰¹é‡æŸ¥è¯¢å·²æ¨é€çš„ chatId
        List<Long> pushedChatIds = pushRecordMapper.selectPushedChatIds(
            video.getId(),
            new java.util.ArrayList<>(targetChatIds),
            PushRecord.PushStatus.SUCCESS.name()
        );
        targetChatIds.removeAll(pushedChatIds);

        if (targetChatIds.isEmpty()) {
            crawlerService.markAsPushed(video.getId());
            log.debug("è§†é¢‘ {} å·²æ¨é€ç»™æ‰€æœ‰è®¢é˜…è€…", video.getCode());
            return;
        }

        // æ¨é€ç»™å‰©ä½™çš„ chatId
        log.debug("è§†é¢‘ {} éœ€è¦æ¨é€ç»™ {} ä¸ªè®¢é˜…è€…", video.getCode(), targetChatIds.size());
        for (Long chatId : targetChatIds) {
            pushToChatInternal(video, chatId);
        }

        crawlerService.markAsPushed(video.getId());
        log.info("è§†é¢‘ {} æ¨é€å®Œæˆï¼Œå…±æ¨é€ç»™ {} ä¸ªè®¢é˜…è€…", video.getCode(), targetChatIds.size());
    }

    private void pushToChatInternal(Video video, Long chatId) {
        boolean success = telegramMessageService.pushVideo(chatId, video);

        PushRecord record = PushRecord.builder()
                .videoId(video.getId())
                .chatId(chatId)
                .status(success ? PushRecord.PushStatus.SUCCESS : PushRecord.PushStatus.FAILED)
                .failReason(success ? null : "æ¨é€å¤±è´¥")
                .pushedAt(LocalDateTime.now())
                .build();
        pushRecordMapper.insert(record);

        if (success) {
            log.info("æ¨é€æˆåŠŸ: {} -> chatId={}", video.getCode(), chatId);
        } else {
            log.warn("æ¨é€å¤±è´¥: {} -> chatId={}", video.getCode(), chatId);
        }

        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    @Override
    public void pushVideoToChat(Video video, Long chatId) {
        pushToChatInternal(video, chatId);
    }

    @Override
    @Transactional
    public void pushUnpushedVideos() {
        List<Video> unpushedVideos = crawlerService.getUnpushedVideos();
        log.debug("å¾…æ¨é€è§†é¢‘æ•°: {}", unpushedVideos.size());

        for (Video video : unpushedVideos) {
            pushVideoToSubscribers(video);
        }
    }
}



com/missav/bot/push/service/IPushService.java
package com.missav.bot.push.service;

import com.missav.bot.video.entity.Video;

/**
 * æ¨é€æœåŠ¡æ¥å£
 */
public interface IPushService {

    /**
     * æ¨é€è§†é¢‘åˆ°æ‰€æœ‰åŒ¹é…çš„è®¢é˜…è€…
     * @param video è§†é¢‘
     */
    void pushVideoToSubscribers(Video video);

    /**
     * æ¨é€æ‰€æœ‰æœªæ¨é€çš„è§†é¢‘
     */
    void pushUnpushedVideos();

    /**
     * æ¨é€è§†é¢‘ç»™æŒ‡å®šç”¨æˆ·ï¼ˆä¼šè®°å½•åˆ° push_records è¡¨ï¼Œé¿å…é‡å¤æ¨é€ï¼‰
     * @param video è§†é¢‘
     * @param chatId èŠå¤©ID
     */
    void pushVideoToChat(Video video, Long chatId);
}



com/missav/bot/scheduler/CrawlScheduler.java
package com.missav.bot.scheduler;

import com.missav.bot.subscription.entity.Subscription.SubscriptionType;
import com.missav.bot.video.entity.Video;
import com.missav.bot.crawler.service.ICrawlerService;
import com.missav.bot.push.service.IPushService;
import com.missav.bot.subscription.service.ISubscriptionService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import jakarta.annotation.PostConstruct;
import java.util.List;
import java.util.concurrent.atomic.AtomicBoolean;

@Slf4j
@Component
@RequiredArgsConstructor
public class CrawlScheduler {

    private final ICrawlerService crawlerService;
    private final IPushService pushService;
    private final ISubscriptionService subscriptionService;

    private final AtomicBoolean isRunning = new AtomicBoolean(false);

    @Value("${crawler.enabled:true}")
    private boolean crawlerEnabled;

    @Value("${crawler.initial-pages:2}")
    private int initialPages;

    @Value("${telegram.bot.default-chat-id:0}")
    private Long defaultChatId;

    /**
     * å¯åŠ¨æ—¶æ‰§è¡Œé¦–æ¬¡æŠ“å–
     */
    @PostConstruct
    public void init() {
        // å¦‚æœé…ç½®äº†é»˜è®¤ Chat IDï¼Œè‡ªåŠ¨åˆ›å»ºè®¢é˜…
        if (defaultChatId != 0) {
            try {
                subscriptionService.subscribe(defaultChatId, "supergroup", SubscriptionType.ALL, null);
                log.info("å·²è‡ªåŠ¨è®¢é˜…é»˜è®¤ç¾¤ç»„: {}", defaultChatId);
            } catch (Exception e) {
                log.warn("è®¢é˜…é»˜è®¤ç¾¤ç»„å¤±è´¥: {}", e.getMessage());
            }
        } else {
            log.info("æœªé…ç½® BOT_CHAT_IDï¼ŒBot ä¼šåœ¨æ”¶åˆ°ç¾¤ç»„æ¶ˆæ¯æ—¶è‡ªåŠ¨è®¢é˜…");
        }

        // æ‰§è¡Œé¦–æ¬¡æŠ“å–
        if (crawlerEnabled) {
            log.info("æœºå™¨äººå¯åŠ¨ï¼Œæ‰§è¡Œé¦–æ¬¡æŠ“å–...");
            // å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡å¯åŠ¨
            new Thread(() -> {
                try {
                    Thread.sleep(5000); // ç­‰å¾…5ç§’ç¡®ä¿Botå®Œå…¨å¯åŠ¨
                    executeCrawlAndPush(initialPages);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }).start();
        }
    }

    /**
     * å®šæ—¶æŠ“å–æ–°è§†é¢‘ - æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(fixedDelayString = "${crawler.interval:900000}", initialDelay = 60000)
    public void scheduledCrawl() {
        if (!crawlerEnabled) {
            log.debug("çˆ¬è™«å·²ç¦ç”¨");
            return;
        }
        executeCrawlAndPush(1);
    }

    /**
     * æ‰§è¡ŒæŠ“å–å’Œæ¨é€
     */
    private void executeCrawlAndPush(int pages) {
        // é˜²æ­¢å¹¶å‘æ‰§è¡Œ
        if (!isRunning.compareAndSet(false, true)) {
            log.warn("ä¸Šä¸€æ¬¡æŠ“å–ä»»åŠ¡å°šæœªå®Œæˆï¼Œè·³è¿‡æœ¬æ¬¡æ‰§è¡Œ");
            return;
        }

        try {
            log.info("å¼€å§‹å®šæ—¶æŠ“å–ä»»åŠ¡...");
            long startTime = System.currentTimeMillis();

            // 1. æŠ“å–æ–°è§†é¢‘
            List<Video> newVideos = crawlerService.crawlAndSaveNewVideos(pages);
            log.info("æŠ“å–å®Œæˆï¼Œå‘ç°{}ä¸ªæ–°è§†é¢‘", newVideos.size());

            // 2. æ¨é€æœªæ¨é€çš„è§†é¢‘
            pushService.pushUnpushedVideos();

            long duration = System.currentTimeMillis() - startTime;
            log.info("å®šæ—¶ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶{}ms", duration);

        } catch (Exception e) {
            log.error("å®šæ—¶æŠ“å–ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } finally {
            isRunning.set(false);
        }
    }

    /**
     * å®šæœŸæ¸…ç†æ—§æ¨é€è®°å½•
     */
    @Scheduled(cron = "${crawler.cleanup-cron:0 0 3 * * ?}")
    public void cleanupOldRecords() {
        log.info("æ‰§è¡Œæ¸…ç†ä»»åŠ¡...");
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ¸…ç†é€»è¾‘
    }
}



com/missav/bot/subscription/controller/SubscriptionController.java
package com.missav.bot.subscription.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.missav.bot.common.Result;
import com.missav.bot.subscription.entity.Subscription;
import com.missav.bot.subscription.mapper.SubscriptionMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * è®¢é˜…ç®¡ç†æ¥å£
 */
@RestController
@RequestMapping("/api/subscriptions")
@RequiredArgsConstructor
public class SubscriptionController {

    private final SubscriptionMapper subscriptionMapper;

    /**
     * åˆ†é¡µæŸ¥è¯¢è®¢é˜…åˆ—è¡¨
     */
    @GetMapping
    public Result<IPage<Subscription>> list(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer size) {
        Page<Subscription> pageParam = new Page<>(page, size);
        IPage<Subscription> result = subscriptionMapper.selectPage(pageParam, null);
        return Result.success(result);
    }

    /**
     * æ ¹æ®IDæŸ¥è¯¢è®¢é˜…
     */
    @GetMapping("/{id}")
    public Result<Subscription> getById(@PathVariable Long id) {
        Subscription subscription = subscriptionMapper.selectById(id);
        if (subscription == null) {
            return Result.error(404, "è®¢é˜…ä¸å­˜åœ¨");
        }
        return Result.success(subscription);
    }

    /**
     * æŸ¥è¯¢æŒ‡å®šèŠå¤©çš„è®¢é˜…
     */
    @GetMapping("/chat/{chatId}")
    public Result<List<Subscription>> getByChatId(@PathVariable Long chatId) {
        List<Subscription> subscriptions = subscriptionMapper.selectByChatIdAndEnabledTrue(chatId);
        return Result.success(subscriptions);
    }

    /**
     * åˆ›å»ºè®¢é˜…
     */
    @PostMapping
    public Result<Subscription> create(@RequestBody Subscription subscription) {
        String typeStr = subscription.getType().name();
        if (subscriptionMapper.existsByChatIdAndTypeAndKeyword(
                subscription.getChatId(), typeStr, subscription.getKeyword())) {
            return Result.error(400, "è®¢é˜…å·²å­˜åœ¨");
        }
        subscriptionMapper.insert(subscription);
        return Result.success(subscription);
    }

    /**
     * æ›´æ–°è®¢é˜…
     */
    @PutMapping("/{id}")
    public Result<Subscription> update(@PathVariable Long id, @RequestBody Subscription subscription) {
        Subscription existing = subscriptionMapper.selectById(id);
        if (existing == null) {
            return Result.error(404, "è®¢é˜…ä¸å­˜åœ¨");
        }
        subscription.setId(id);
        subscriptionMapper.updateById(subscription);
        return Result.success(subscription);
    }

    /**
     * åˆ é™¤è®¢é˜…
     */
    @DeleteMapping("/{id}")
    public Result<Void> delete(@PathVariable Long id) {
        Subscription existing = subscriptionMapper.selectById(id);
        if (existing == null) {
            return Result.error(404, "è®¢é˜…ä¸å­˜åœ¨");
        }
        subscriptionMapper.deleteById(id);
        return Result.success();
    }

    /**
     * åˆ é™¤æŒ‡å®šèŠå¤©çš„æ‰€æœ‰è®¢é˜…
     */
    @DeleteMapping("/chat/{chatId}")
    public Result<Void> deleteByChatId(@PathVariable Long chatId) {
        subscriptionMapper.deleteByChatId(chatId);
        return Result.success();
    }

    /**
     * æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„èŠå¤©ID
     */
    @GetMapping("/active-chats")
    public Result<List<Long>> getActiveChats() {
        List<Long> chatIds = subscriptionMapper.selectDistinctChatIdByEnabledTrue();
        return Result.success(chatIds);
    }
}



com/missav/bot/subscription/entity/Subscription.java
package com.missav.bot.subscription.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.missav.bot.common.entity.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import lombok.Builder;

/**
 * è®¢é˜…å®ä½“
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(callSuper = true)
@TableName("subscriptions")
public class Subscription extends BaseEntity {

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * TelegramèŠå¤©IDï¼ˆç”¨æˆ·æˆ–ç¾¤ç»„ï¼‰
     */
    private Long chatId;

    /**
     * èŠå¤©ç±»å‹ï¼šprivate-ç§èŠï¼Œgroup-ç¾¤ç»„ï¼Œsupergroup-è¶…çº§ç¾¤ç»„
     */
    private String chatType;

    /**
     * è®¢é˜…ç±»å‹ï¼šALL-å…¨éƒ¨ï¼ŒACTRESS-æ¼”å‘˜ï¼ŒTAG-æ ‡ç­¾
     */
    private SubscriptionType type;

    /**
     * è®¢é˜…å…³é”®è¯ï¼ˆæ¼”å‘˜åæˆ–æ ‡ç­¾åï¼‰
     */
    private String keyword;

    /**
     * æ˜¯å¦å¯ç”¨ï¼š0-ç¦ç”¨ï¼Œ1-å¯ç”¨
     */
    private Boolean enabled;

    public enum SubscriptionType {
        ALL,      // è®¢é˜…å…¨éƒ¨
        ACTRESS,  // è®¢é˜…æ¼”å‘˜
        TAG       // è®¢é˜…æ ‡ç­¾
    }
}



com/missav/bot/subscription/mapper/SubscriptionMapper.java
package com.missav.bot.subscription.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.missav.bot.subscription.entity.Subscription;
import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import java.util.List;

@Mapper
public interface SubscriptionMapper extends BaseMapper<Subscription> {

    /**
     * æŸ¥æ‰¾èŠå¤©çš„æ‰€æœ‰å¯ç”¨è®¢é˜…
     */
    @Select("SELECT * FROM subscriptions WHERE chat_id = #{chatId} AND enabled = 1")
    List<Subscription> selectByChatIdAndEnabledTrue(@Param("chatId") Long chatId);

    /**
     * æŸ¥æ‰¾æ‰€æœ‰å¯ç”¨çš„æŒ‡å®šç±»å‹è®¢é˜…
     */
    @Select("SELECT * FROM subscriptions WHERE type = #{type} AND enabled = 1")
    List<Subscription> selectByTypeAndEnabledTrue(@Param("type") String type);

    /**
     * æŸ¥æ‰¾æŒ‡å®šç±»å‹å’Œå…³é”®è¯çš„è®¢é˜…
     */
    @Select("SELECT * FROM subscriptions WHERE type = #{type} AND keyword = #{keyword} AND enabled = 1")
    List<Subscription> selectByTypeAndKeywordAndEnabledTrue(@Param("type") String type, @Param("keyword") String keyword);

    /**
     * æ£€æŸ¥è®¢é˜…æ˜¯å¦å­˜åœ¨
     */
    @Select("SELECT COUNT(*) > 0 FROM subscriptions WHERE chat_id = #{chatId} AND type = #{type} AND keyword = #{keyword}")
    boolean existsByChatIdAndTypeAndKeyword(@Param("chatId") Long chatId, @Param("type") String type, @Param("keyword") String keyword);

    /**
     * æŸ¥æ‰¾ç‰¹å®šè®¢é˜…
     */
    @Select("SELECT * FROM subscriptions WHERE chat_id = #{chatId} AND type = #{type} AND keyword = #{keyword}")
    Subscription selectByChatIdAndTypeAndKeyword(@Param("chatId") Long chatId, @Param("type") String type, @Param("keyword") String keyword);

    /**
     * åˆ é™¤èŠå¤©çš„æ‰€æœ‰è®¢é˜…
     */
    @Delete("DELETE FROM subscriptions WHERE chat_id = #{chatId}")
    int deleteByChatId(@Param("chatId") Long chatId);

    /**
     * è·å–æ‰€æœ‰éœ€è¦æ¨é€çš„èŠå¤©IDï¼ˆå»é‡ï¼‰
     */
    @Select("SELECT DISTINCT chat_id FROM subscriptions WHERE enabled = 1")
    List<Long> selectDistinctChatIdByEnabledTrue();
}



com/missav/bot/subscription/service/impl/SubscriptionServiceImpl.java
package com.missav.bot.subscription.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.missav.bot.subscription.entity.Subscription;
import com.missav.bot.subscription.entity.Subscription.SubscriptionType;
import com.missav.bot.subscription.mapper.SubscriptionMapper;
import com.missav.bot.subscription.service.ISubscriptionService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Slf4j
@Service
public class SubscriptionServiceImpl extends ServiceImpl<SubscriptionMapper, Subscription> implements ISubscriptionService {

    @Override
    @Transactional
    public Subscription subscribe(Long chatId, String chatType, SubscriptionType type, String keyword) {
        String typeStr = type.name();
        if (baseMapper.existsByChatIdAndTypeAndKeyword(chatId, typeStr, keyword)) {
            log.info("è®¢é˜…å·²å­˜åœ¨: chatId={}, type={}, keyword={}", chatId, type, keyword);
            return baseMapper.selectByChatIdAndTypeAndKeyword(chatId, typeStr, keyword);
        }

        Subscription subscription = Subscription.builder()
                .chatId(chatId)
                .chatType(chatType)
                .type(type)
                .keyword(keyword)
                .enabled(true)
                .build();

        save(subscription);
        log.info("æ·»åŠ è®¢é˜…: chatId={}, type={}, keyword={}", chatId, type, keyword);
        return subscription;
    }

    @Override
    @Transactional
    public void unsubscribe(Long chatId, SubscriptionType type, String keyword) {
        String typeStr = type.name();
        Subscription sub = baseMapper.selectByChatIdAndTypeAndKeyword(chatId, typeStr, keyword);
        if (sub != null) {
            sub.setEnabled(false);
            updateById(sub);
            log.info("å–æ¶ˆè®¢é˜…: chatId={}, type={}, keyword={}", chatId, type, keyword);
        }
    }

    @Override
    @Transactional
    public void unsubscribeAll(Long chatId) {
        List<Subscription> subscriptions = baseMapper.selectByChatIdAndEnabledTrue(chatId);
        for (Subscription sub : subscriptions) {
            sub.setEnabled(false);
        }
        updateBatchById(subscriptions);
        log.info("å–æ¶ˆå…¨éƒ¨è®¢é˜…: chatId={}, count={}", chatId, subscriptions.size());
    }

    @Override
    public List<Subscription> getSubscriptions(Long chatId) {
        return baseMapper.selectByChatIdAndEnabledTrue(chatId);
    }

    @Override
    public List<Subscription> getAllSubscriptions() {
        return baseMapper.selectByTypeAndEnabledTrue(SubscriptionType.ALL.name());
    }

    @Override
    public List<Subscription> getActressSubscriptions(String actress) {
        return baseMapper.selectByTypeAndKeywordAndEnabledTrue(SubscriptionType.ACTRESS.name(), actress);
    }

    @Override
    public List<Subscription> getTagSubscriptions(String tag) {
        return baseMapper.selectByTypeAndKeywordAndEnabledTrue(SubscriptionType.TAG.name(), tag);
    }

    @Override
    public boolean matchesSubscription(Subscription subscription, String actresses, String tags) {
        if (subscription.getType() == SubscriptionType.ALL) {
            return true;
        }

        String keyword = subscription.getKeyword();
        if (keyword == null || keyword.isEmpty()) {
            return false;
        }

        if (subscription.getType() == SubscriptionType.ACTRESS) {
            return actresses != null && actresses.contains(keyword);
        }

        if (subscription.getType() == SubscriptionType.TAG) {
            return tags != null && tags.contains(keyword);
        }

        return false;
    }
}



com/missav/bot/subscription/service/ISubscriptionService.java
package com.missav.bot.subscription.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.missav.bot.subscription.entity.Subscription;
import com.missav.bot.subscription.entity.Subscription.SubscriptionType;

import java.util.List;

/**
 * è®¢é˜…æœåŠ¡æ¥å£
 */
public interface ISubscriptionService extends IService<Subscription> {

    /**
     * æ·»åŠ è®¢é˜…
     */
    Subscription subscribe(Long chatId, String chatType, SubscriptionType type, String keyword);

    /**
     * å–æ¶ˆç‰¹å®šè®¢é˜…
     */
    void unsubscribe(Long chatId, SubscriptionType type, String keyword);

    /**
     * å–æ¶ˆå…¨éƒ¨è®¢é˜…
     */
    void unsubscribeAll(Long chatId);

    /**
     * è·å–ç”¨æˆ·çš„è®¢é˜…åˆ—è¡¨
     */
    List<Subscription> getSubscriptions(Long chatId);

    /**
     * è·å–æ‰€æœ‰è®¢é˜…å…¨éƒ¨çš„èŠå¤©
     */
    List<Subscription> getAllSubscriptions();

    /**
     * è·å–è®¢é˜…æŒ‡å®šæ¼”å‘˜çš„èŠå¤©
     */
    List<Subscription> getActressSubscriptions(String actress);

    /**
     * è·å–è®¢é˜…æŒ‡å®šæ ‡ç­¾çš„èŠå¤©
     */
    List<Subscription> getTagSubscriptions(String tag);

    /**
     * æ£€æŸ¥è§†é¢‘æ˜¯å¦åŒ¹é…è®¢é˜…
     */
    boolean matchesSubscription(Subscription subscription, String actresses, String tags);
}



com/missav/bot/telegram/TelegramMessageService.java
package com.missav.bot.telegram;

import com.missav.bot.video.entity.Video;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.methods.send.SendPhoto;
import org.telegram.telegrambots.meta.api.methods.send.SendVideo;
import org.telegram.telegrambots.meta.api.objects.InputFile;
import org.telegram.telegrambots.meta.bots.AbsSender;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

/**
 * Telegram æ¶ˆæ¯å‘é€æœåŠ¡
 * è´Ÿè´£æ‰€æœ‰ Telegram æ¶ˆæ¯çš„æ ¼å¼åŒ–å’Œå‘é€
 */
@Slf4j
@Service
public class TelegramMessageService {

    private AbsSender bot;

    @Value("${telegram.bot.username:MissavBot}")
    private String botUsername;

    /**
     * è®¾ç½® Bot å®ä¾‹ï¼ˆç”± MissavBot å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
     */
    public void setBot(AbsSender bot) {
        this.bot = bot;
    }

    /**
     * æ¨é€è§†é¢‘åˆ°æŒ‡å®šèŠå¤©
     * @return æ˜¯å¦æ¨é€æˆåŠŸ
     */
    public boolean pushVideo(Long chatId, Video video) {
        try {
            String caption = formatVideoMessage(video);

            // ä¼˜å…ˆå‘é€é¢„è§ˆè§†é¢‘
            if (video.getPreviewUrl() != null && !video.getPreviewUrl().isEmpty()) {
                return sendVideoWithCaption(chatId, video.getPreviewUrl(), video.getCoverUrl(), caption);
            }

            // å…¶æ¬¡å‘é€å°é¢å›¾
            if (video.getCoverUrl() != null && !video.getCoverUrl().isEmpty()) {
                return sendPhotoWithCaption(chatId, video.getCoverUrl(), caption);
            }

            // æœ€åå‘é€çº¯æ–‡æœ¬
            sendMarkdown(chatId, caption);
            return true;
        } catch (Exception e) {
            log.error("æ¨é€è§†é¢‘å¤±è´¥: chatId={}, code={}", chatId, video.getCode(), e);
            return false;
        }
    }

    /**
     * æ ¼å¼åŒ–è§†é¢‘æ¶ˆæ¯
     */
    public String formatVideoMessage(Video video) {
        StringBuilder sb = new StringBuilder();
        sb.append("ğŸ¬ *æ–°ç‰‡ä¸Šæ¶*\n\n");
        sb.append("ğŸ“Œ ç•ªå·: `").append(escapeMarkdown(video.getCode())).append("`\n");

        if (video.getActresses() != null && !video.getActresses().isEmpty()) {
            sb.append("ğŸ‘© æ¼”å‘˜: ").append(escapeMarkdown(video.getActresses())).append("\n");
        }

        if (video.getTags() != null && !video.getTags().isEmpty()) {
            sb.append("ğŸ·ï¸ æ ‡ç­¾: ").append(formatTags(video.getTags())).append("\n");
        }

        if (video.getDuration() != null) {
            sb.append("â±ï¸ æ—¶é•¿: ").append(video.getDuration()).append(" åˆ†é’Ÿ\n");
        }

        sb.append("\nğŸ”— [æŸ¥çœ‹è¯¦æƒ…](").append(video.getDetailUrl()).append(")");

        return sb.toString();
    }

    /**
     * è½¬ä¹‰ Markdown ç‰¹æ®Šå­—ç¬¦
     */
    private String escapeMarkdown(String text) {
        if (text == null) return "";
        return text.replace("_", "\\_")
                   .replace("*", "\\*")
                   .replace("[", "\\[")
                   .replace("]", "\\]")
                   .replace("(", "\\(")
                   .replace(")", "\\)")
                   .replace("~", "\\~")
                   .replace("`", "\\`")
                   .replace(">", "\\>")
                   .replace("#", "\\#")
                   .replace("+", "\\+")
                   .replace("-", "\\-")
                   .replace("=", "\\=")
                   .replace("|", "\\|")
                   .replace("{", "\\{")
                   .replace("}", "\\}")
                   .replace(".", "\\.")
                   .replace("!", "\\!");
    }

    private String formatTags(String tags) {
        if (tags == null) return "";
        String[] tagArr = tags.split(",\\s*");
        StringBuilder sb = new StringBuilder();
        for (String tag : tagArr) {
            sb.append("#").append(escapeMarkdown(tag.trim())).append(" ");
        }
        return sb.toString().trim();
    }

    public boolean sendVideoWithCaption(Long chatId, String videoUrl, String thumbUrl, String caption) {
        try {
            SendVideo sendVideo = new SendVideo();
            sendVideo.setChatId(chatId.toString());
            sendVideo.setVideo(new InputFile(videoUrl));
            if (thumbUrl != null && !thumbUrl.isEmpty()) {
                sendVideo.setThumbnail(new InputFile(thumbUrl));
            }
            sendVideo.setCaption(caption);
            sendVideo.setParseMode("Markdown");
            bot.execute(sendVideo);
            return true;
        } catch (TelegramApiException e) {
            log.warn("å‘é€è§†é¢‘å¤±è´¥ï¼Œå°è¯•å‘é€å›¾ç‰‡: {}", e.getMessage());
            return sendPhotoWithCaption(chatId, thumbUrl, caption);
        }
    }

    public boolean sendPhotoWithCaption(Long chatId, String photoUrl, String caption) {
        // éªŒè¯ URL æ˜¯å¦æœ‰æ•ˆ
        if (photoUrl == null || photoUrl.trim().isEmpty()) {
            log.warn("å›¾ç‰‡ URL ä¸ºç©ºï¼Œç›´æ¥å‘é€çº¯æ–‡æœ¬");
            sendMarkdown(chatId, caption);
            return true;
        }

        // éªŒè¯ URL æ ¼å¼
        if (!photoUrl.startsWith("http://") && !photoUrl.startsWith("https://")) {
            log.warn("å›¾ç‰‡ URL æ ¼å¼æ— æ•ˆ: {}, ç›´æ¥å‘é€çº¯æ–‡æœ¬", photoUrl);
            sendMarkdown(chatId, caption);
            return true;
        }

        try {
            SendPhoto sendPhoto = new SendPhoto();
            sendPhoto.setChatId(chatId.toString());
            sendPhoto.setPhoto(new InputFile(photoUrl.trim()));
            sendPhoto.setCaption(caption);
            sendPhoto.setParseMode("Markdown");
            bot.execute(sendPhoto);
            return true;
        } catch (TelegramApiException e) {
            log.warn("å‘é€å›¾ç‰‡å¤±è´¥ (URL: {}): {}, å‘é€çº¯æ–‡æœ¬", photoUrl, e.getMessage());
            sendMarkdown(chatId, caption);
            return true;
        }
    }

    public void sendMarkdown(Long chatId, String text) {
        try {
            SendMessage message = new SendMessage();
            message.setChatId(chatId.toString());
            message.setText(text);
            message.setParseMode("Markdown");
            bot.execute(message);
        } catch (TelegramApiException e) {
            log.error("å‘é€æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}



com/missav/bot/video/controller/VideoController.java
package com.missav.bot.video.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.missav.bot.common.Result;
import com.missav.bot.video.entity.Video;
import com.missav.bot.video.mapper.VideoMapper;
import com.missav.bot.video.service.IVideoService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * è§†é¢‘ç®¡ç†æ¥å£
 */
@RestController
@RequestMapping("/api/videos")
@RequiredArgsConstructor
public class VideoController {

    private final IVideoService videoService;
    private final VideoMapper videoMapper;

    /**
     * åˆ†é¡µæŸ¥è¯¢è§†é¢‘åˆ—è¡¨
     */
    @GetMapping
    public Result<IPage<Video>> list(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer size) {
        Page<Video> pageParam = new Page<>(page, size);
        IPage<Video> result = videoService.page(pageParam);
        return Result.success(result);
    }

    /**
     * æ ¹æ®IDæŸ¥è¯¢è§†é¢‘
     */
    @GetMapping("/{id}")
    public Result<Video> getById(@PathVariable Long id) {
        Video video = videoService.getById(id);
        if (video == null) {
            return Result.error(404, "è§†é¢‘ä¸å­˜åœ¨");
        }
        return Result.success(video);
    }

    /**
     * æ ¹æ®ç•ªå·æŸ¥è¯¢è§†é¢‘
     */
    @GetMapping("/code/{code}")
    public Result<Video> getByCode(@PathVariable String code) {
        Video video = videoMapper.selectByCode(code);
        if (video == null) {
            return Result.error(404, "è§†é¢‘ä¸å­˜åœ¨");
        }
        return Result.success(video);
    }

    /**
     * æœç´¢è§†é¢‘ï¼ˆæŒ‰æ¼”å‘˜ï¼‰
     */
    @GetMapping("/search/actress")
    public Result<List<Video>> searchByActress(@RequestParam String actress) {
        List<Video> videos = videoMapper.selectByActress(actress);
        return Result.success(videos);
    }

    /**
     * æœç´¢è§†é¢‘ï¼ˆæŒ‰æ ‡ç­¾ï¼‰
     */
    @GetMapping("/search/tag")
    public Result<List<Video>> searchByTag(@RequestParam String tag) {
        List<Video> videos = videoMapper.selectByTag(tag);
        return Result.success(videos);
    }

    /**
     * åˆ›å»ºè§†é¢‘
     */
    @PostMapping
    public Result<Video> create(@RequestBody Video video) {
        if (videoMapper.existsByCode(video.getCode())) {
            return Result.error(400, "ç•ªå·å·²å­˜åœ¨");
        }
        videoService.save(video);
        return Result.success(video);
    }

    /**
     * æ›´æ–°è§†é¢‘
     */
    @PutMapping("/{id}")
    public Result<Video> update(@PathVariable Long id, @RequestBody Video video) {
        Video existing = videoService.getById(id);
        if (existing == null) {
            return Result.error(404, "è§†é¢‘ä¸å­˜åœ¨");
        }
        video.setId(id);
        videoService.updateById(video);
        return Result.success(video);
    }

    /**
     * åˆ é™¤è§†é¢‘
     */
    @DeleteMapping("/{id}")
    public Result<Void> delete(@PathVariable Long id) {
        Video existing = videoService.getById(id);
        if (existing == null) {
            return Result.error(404, "è§†é¢‘ä¸å­˜åœ¨");
        }
        videoService.removeById(id);
        return Result.success();
    }

    /**
     * æŸ¥è¯¢æœªæ¨é€çš„è§†é¢‘
     */
    @GetMapping("/unpushed")
    public Result<List<Video>> getUnpushed() {
        List<Video> videos = videoMapper.selectUnpushedVideos();
        return Result.success(videos);
    }

    /**
     * æŸ¥è¯¢æœ€æ–°è§†é¢‘
     */
    @GetMapping("/latest")
    public Result<List<Video>> getLatest() {
        List<Video> videos = videoMapper.selectTop50ByCreatedTimeDesc();
        return Result.success(videos);
    }
}



com/missav/bot/video/entity/Video.java
package com.missav.bot.video.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.missav.bot.common.entity.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import lombok.Builder;

import java.time.LocalDateTime;

/**
 * è§†é¢‘å®ä½“
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(callSuper = true)
@TableName("videos")
public class Video extends BaseEntity {

    @TableId(type = IdType.AUTO)
    private Long id;

    private String code;
    private String title;
    private String actresses;
    private String tags;
    private Integer duration;
    private LocalDateTime releaseDate;
    private String coverUrl;
    private String previewUrl;
    private String detailUrl;
    private Boolean pushed;
}



com/missav/bot/video/mapper/VideoMapper.java
package com.missav.bot.video.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.missav.bot.video.entity.Video;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import java.time.LocalDateTime;
import java.util.List;

@Mapper
public interface VideoMapper extends BaseMapper<Video> {

    /**
     * æ ¹æ®ç•ªå·æŸ¥æ‰¾è§†é¢‘
     */
    @Select("SELECT * FROM videos WHERE code = #{code}")
    Video selectByCode(@Param("code") String code);

    /**
     * æ£€æŸ¥ç•ªå·æ˜¯å¦å­˜åœ¨
     */
    @Select("SELECT COUNT(*) > 0 FROM videos WHERE code = #{code}")
    boolean existsByCode(@Param("code") String code);

    /**
     * æŸ¥æ‰¾æœªæ¨é€çš„è§†é¢‘
     */
    @Select("SELECT * FROM videos WHERE pushed = 0 ORDER BY created_time ASC")
    List<Video> selectUnpushedVideos();

    /**
     * æ ¹æ®æ¼”å‘˜æŸ¥æ‰¾è§†é¢‘
     */
    @Select("SELECT * FROM videos WHERE actresses LIKE CONCAT('%', #{actress}, '%')")
    List<Video> selectByActress(@Param("actress") String actress);

    /**
     * æ ¹æ®æ ‡ç­¾æŸ¥æ‰¾è§†é¢‘
     */
    @Select("SELECT * FROM videos WHERE tags LIKE CONCAT('%', #{tag}, '%')")
    List<Video> selectByTag(@Param("tag") String tag);

    /**
     * æŸ¥æ‰¾æŒ‡å®šæ—¶é—´ååˆ›å»ºçš„è§†é¢‘
     */
    @Select("SELECT * FROM videos WHERE created_time > #{time} ORDER BY created_time DESC")
    List<Video> selectByCreatedTimeAfter(@Param("time") LocalDateTime time);

    /**
     * æŸ¥æ‰¾æœ€æ–°çš„Næ¡è§†é¢‘
     */
    @Select("SELECT * FROM videos ORDER BY created_time DESC LIMIT 50")
    List<Video> selectTop50ByCreatedTimeDesc();

    /**
     * æ‰¹é‡æ£€æŸ¥ç•ªå·æ˜¯å¦å­˜åœ¨
     */
    @Select("<script>" +
            "SELECT code FROM videos WHERE code IN " +
            "<foreach collection='codes' item='code' open='(' separator=',' close=')'>" +
            "#{code}" +
            "</foreach>" +
            "</script>")
    List<String> selectExistingCodes(@Param("codes") List<String> codes);
}



com/missav/bot/video/service/impl/VideoServiceImpl.java
package com.missav.bot.video.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.missav.bot.video.entity.Video;
import com.missav.bot.video.mapper.VideoMapper;
import com.missav.bot.video.service.IVideoService;
import org.springframework.stereotype.Service;

/**
 * è§†é¢‘æœåŠ¡å®ç°
 */
@Service
public class VideoServiceImpl extends ServiceImpl<VideoMapper, Video> implements IVideoService {
}



com/missav/bot/video/service/IVideoService.java
package com.missav.bot.video.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.missav.bot.video.entity.Video;

/**
 * è§†é¢‘æœåŠ¡æ¥å£
 */
public interface IVideoService extends IService<Video> {
}



com/missav/bot/MissavBotApplication.java
package com.missav.bot;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
@EnableScheduling
public class MissavBotApplication {

    public static void main(String[] args) {
        SpringApplication.run(MissavBotApplication.class, args);
    }
}



application.yaml
server:
  port: 8000

spring:
  application:
    name: missav-bot

  servlet:
    multipart:
      enabled: false  # ç¦ç”¨æ–‡ä»¶ä¸Šä¼ è§£æï¼ŒBot ä¸éœ€è¦æ­¤åŠŸèƒ½

  sql:
    init:
      mode: never

  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:3308/missav_bot?useSSL=false&serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=UTF-8&allowPublicKeyRetrieval=true
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:your_password}

mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    # ç”Ÿäº§ç¯å¢ƒå…³é—­ SQL æ—¥å¿—ï¼Œå¼€å‘æ—¶å¯ä»¥æ‰“å¼€
    # log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-value: 1
      logic-not-delete-value: 0

telegram:
  bot:
    token: ${BOT_TOKEN:YOUR_BOT_TOKEN}
    username: ${BOT_USERNAME:YOUR_BOT_USERNAME}
    default-chat-id: ${BOT_CHAT_ID:0}

crawler:
  enabled: ${CRAWLER_ENABLED:true}
  interval: ${CRAWLER_INTERVAL:900000}  # çˆ¬å–é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤15åˆ†é’Ÿ
  initial-pages: ${CRAWLER_INITIAL_PAGES:2}  # é¦–æ¬¡å¯åŠ¨çˆ¬å–é¡µæ•°
  cleanup-cron: ${CRAWLER_CLEANUP_CRON:0 0 3 * * ?}  # æ¸…ç†ä»»åŠ¡ cron è¡¨è¾¾å¼ï¼Œé»˜è®¤æ¯å¤©å‡Œæ™¨3ç‚¹
  user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36

logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.missav.bot: ${LOG_LEVEL_APP:INFO}
    com.missav.bot.crawler: ${LOG_LEVEL_CRAWLER:INFO}
    com.missav.bot.push: ${LOG_LEVEL_PUSH:INFO}
    com.missav.bot.scheduler: ${LOG_LEVEL_SCHEDULER:INFO}
    org.telegram: ${LOG_LEVEL_TELEGRAM:WARN}
    com.zaxxer.hikari: ${LOG_LEVEL_HIKARI:WARN}
    org.springframework: ${LOG_LEVEL_SPRING:WARN}
    # SQL æ—¥å¿—ï¼ˆmapper çº§åˆ«ï¼‰
    com.missav.bot.video.mapper: ${LOG_LEVEL_SQL:INFO}
    com.missav.bot.push.mapper: ${LOG_LEVEL_SQL:INFO}
    com.missav.bot.subscription.mapper: ${LOG_LEVEL_SQL:INFO}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/missav-bot.log

management:
  endpoints:
    web:
      exposure:
        include: health
  endpoint:
    health:
      show-details: when-authorized



application-local.yaml.example
server:
  port: 9999

spring:
  application:
    name: missav-bot

  sql:
    init:
      mode: never

  datasource:
    url: jdbc:mysql://localhost:3306/missav_bot?useSSL=false&serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=UTF-8&allowPublicKeyRetrieval=true
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: root
    password: 123456

# MyBatis-Plusé…ç½®
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-value: 1
      logic-not-delete-value: 0

# Telegram Boté…ç½®
telegram:
  bot:
    token: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
    username: @hello_world_missav_Bot
    default-chat-id: 8077023887

# çˆ¬è™«é…ç½®
crawler:
  enabled: true
  interval: 900000
  initial-pages: 2
  user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36

# æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.missav.bot: DEBUG
    org.telegram: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/missav-bot.log



pom.xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.3.5</version>
        <relativePath/>
    </parent>

    <groupId>com.missav</groupId>
    <artifactId>missav-bot</artifactId>
    <version>1.0.0</version>
    <name>missav-bot</name>
    <description>Telegram Bot for MissAV video notifications</description>

    <properties>
        <java.version>21</java.version>
        <telegram-bots.version>6.9.7.1</telegram-bots.version>
        <mybatis-plus.version>3.5.9</mybatis-plus.version>
        <maven.build.timestamp.format>yyyyMMddHHmmss</maven.build.timestamp.format>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
    </properties>

    <dependencies>
        <!-- Spring Boot -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <!-- MyBatis-Plus -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>${mybatis-plus.version}</version>
            <exclusions>
                <exclusion>
                    <groupId>org.mybatis</groupId>
                    <artifactId>mybatis-spring</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis-spring</artifactId>
            <version>3.0.3</version>
        </dependency>

        <!-- Telegram Bot -->
        <dependency>
            <groupId>org.telegram</groupId>
            <artifactId>telegrambots</artifactId>
            <version>${telegram-bots.version}</version>
        </dependency>

        <!-- Web Crawler -->
        <dependency>
            <groupId>org.jsoup</groupId>
            <artifactId>jsoup</artifactId>
            <version>1.17.2</version>
        </dependency>
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
            <version>4.12.0</version>
        </dependency>
        <dependency>
            <groupId>org.seleniumhq.selenium</groupId>
            <artifactId>selenium-java</artifactId>
            <version>4.27.0</version>
        </dependency>
        <dependency>
            <groupId>io.github.bonigarcia</groupId>
            <artifactId>webdrivermanager</artifactId>
            <version>5.9.2</version>
        </dependency>

        <!-- Database -->
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- Utilities -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>com.google.guava</groupId>
            <artifactId>guava</artifactId>
            <version>33.0.0-jre</version>
        </dependency>

        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <finalName>missav_bot_${maven.build.timestamp}</finalName>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <encoding>UTF-8</encoding>
                    <fork>true</fork>
                    <meminitial>128m</meminitial>
                    <maxmem>512m</maxmem>
                    <compilerArgs>
                        <arg>-J-Duser.language=en</arg>
                        <arg>-J-Duser.country=US</arg>
                        <arg>-J-Dfile.encoding=UTF-8</arg>
                    </compilerArgs>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>3.1.2</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <version>3.3.0</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
                <version>3.3.1</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-clean-plugin</artifactId>
                <version>3.2.0</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-install-plugin</artifactId>
                <version>3.1.1</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-deploy-plugin</artifactId>
                <version>3.1.1</version>
            </plugin>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
